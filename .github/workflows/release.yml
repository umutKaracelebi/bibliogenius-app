name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # Allows manual trigger for testing

env:
  FLUTTER_VERSION: '3.38.4'

jobs:
  # =============================================================================
  # BUILD RUST BACKEND
  # =============================================================================
  build-rust:
    strategy:
      matrix:
        include:
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: bibliogenius-macos-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: bibliogenius-macos-arm64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: bibliogenius-linux-x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: bibliogenius-windows-x64

    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          repository: bibliogenius/bibliogenius
          
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libsqlite3-dev libssl-dev
          
      - name: Build Rust backend
        run: cargo build --release --target ${{ matrix.target }}
        
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            target/${{ matrix.target }}/release/bibliogenius
            target/${{ matrix.target }}/release/bibliogenius.exe

  # =============================================================================
  # BUILD FLUTTER APP (all platforms use default checkout + clone Rust repo)
  # =============================================================================
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Clone Rust repo at expected path (3 levels up from rust_builder subdirs)
      - name: Clone Rust repository
        run: git clone https://github.com/bibliogenius/bibliogenius.git ../bibliogenius
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r25c
          add-to-path: true

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          
      - name: Accept Android Licenses
        run: yes | flutter doctor --android-licenses || true

      - name: Generate Debug Keystore
        run: |
          mkdir -p ~/.android
          keytool -genkey -v -keystore ~/.android/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"

      - name: Create key.properties
        run: |
          echo "storePassword=android" > android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=androiddebugkey" >> android/key.properties
          echo "storeFile=$HOME/.android/debug.keystore" >> android/key.properties

      - name: Create .env file
        run: cp .env.example .env

      - name: Get dependencies
        run: flutter pub get
        
      - name: Build APK
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: flutter build apk --release
        
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: bibliogenius-android
          path: build/app/outputs/flutter-apk/app-release.apk

  build-macos:
    needs: build-rust
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      # Clone Rust repo into rust_builder (same approach as Linux/Windows)
      - name: Clone Rust repository
        run: git clone https://github.com/bibliogenius/bibliogenius.git rust_builder/bibliogenius
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false

      - name: Install CocoaPods
        run: gem install cocoapods
          
      - name: Create .env file
        run: cp .env.example .env

      - name: Get dependencies
        run: flutter pub get
        
      - name: Download Rust Backend (x64)
        uses: actions/download-artifact@v4
        with:
          name: bibliogenius-macos-x64
          path: backend-x64

      - name: Download Rust Backend (ARM64)
        uses: actions/download-artifact@v4
        with:
          name: bibliogenius-macos-arm64
          path: backend-arm64

      - name: Import Apple Certificate
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Import certificate
          echo "$APPLE_CERTIFICATE_P12" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          
          # Store keychain path for later
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

      - name: Build macOS app (signed)
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Update project with correct team ID
          sed -i '' "s/DEVELOPMENT_TEAM = RF374CUSUZ/DEVELOPMENT_TEAM = $APPLE_TEAM_ID/g" macos/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/"Apple Development"/"Developer ID Application"/g' macos/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' macos/Runner.xcodeproj/project.pbxproj
          
          # Build the app
          flutter build macos --release
      
      - name: Validate app bundle
        run: |
          APP_PATH="build/macos/Build/Products/Release/bibliogenius.app"
          
          # Check essential files exist
          if [ ! -f "$APP_PATH/Contents/Info.plist" ]; then
            echo "âŒ ERROR: Info.plist missing!"
            ls -la "$APP_PATH/Contents" || echo "Contents directory doesn't exist"
            exit 1
          fi
          
          if [ ! -f "$APP_PATH/Contents/MacOS/bibliogenius" ]; then
            echo "âŒ ERROR: Main executable missing!"
            ls -la "$APP_PATH/Contents/MacOS" || echo "MacOS directory doesn't exist"
            exit 1
          fi
          
          echo "âœ… App bundle validation passed"
          echo "App bundle structure:"
          ls -la "$APP_PATH/Contents"

      - name: Inject Rust Binary
        run: |
          ARCH=$(uname -m)
          mkdir -p build/macos/Build/Products/Release/bibliogenius.app/Contents/Resources/backend
          if [ "$ARCH" == "arm64" ]; then
            cp backend-arm64/bibliogenius build/macos/Build/Products/Release/bibliogenius.app/Contents/Resources/backend/
          else
            cp backend-x64/bibliogenius build/macos/Build/Products/Release/bibliogenius.app/Contents/Resources/backend/
          fi
          chmod +x build/macos/Build/Products/Release/bibliogenius.app/Contents/Resources/backend/bibliogenius
        
      - name: Create DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "BiblioGenius" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 450 185 \
            "BiblioGenius-macOS.dmg" \
            "build/macos/Build/Products/Release/bibliogenius.app" || true
          # Fallback to zip if create-dmg fails
          if [ ! -f "BiblioGenius-macOS.dmg" ]; then
            cd build/macos/Build/Products/Release
            zip -r ../../../../../BiblioGenius-macOS.zip bibliogenius.app
          fi
          
      - name: Upload macOS app
        uses: actions/upload-artifact@v4
        with:
          name: bibliogenius-macos
          path: |
            BiblioGenius-macOS.dmg
            BiblioGenius-macOS.zip

  build-windows:
    needs: build-rust
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      # Clone Rust repo locally - CMakeLists.txt uses CMAKE_SOURCE_DIR to find it
      - name: Clone Rust repository
        run: git clone https://github.com/bibliogenius/bibliogenius.git rust_builder/bibliogenius

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          
      - name: Create .env file
        run: copy .env.example .env

      - name: Get dependencies
        run: flutter pub get
        
      - name: Download Rust Backend
        uses: actions/download-artifact@v4
        with:
          name: bibliogenius-windows-x64
          path: backend

      - name: Build Windows app
        run: flutter build windows --release

      - name: Inject Rust Binary
        run: |
          mkdir build\windows\x64\runner\Release\backend
          copy backend\bibliogenius.exe build\windows\x64\runner\Release\backend\
        
      - name: Create ZIP
        run: |
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath BiblioGenius-Windows.zip
          
      - name: Upload Windows app
        uses: actions/upload-artifact@v4
        with:
          name: bibliogenius-windows
          path: BiblioGenius-Windows.zip

  build-linux:
    needs: build-rust
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Clone Rust repo locally - CMakeLists.txt uses CMAKE_SOURCE_DIR to find it
      - name: Clone Rust repository
        run: git clone https://github.com/bibliogenius/bibliogenius.git rust_builder/bibliogenius

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libglu1-mesa-dev libstdc++-12-dev libsecret-1-dev libsqlite3-dev libssl-dev

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          
      - name: Create .env file
        run: cp .env.example .env

      - name: Get dependencies
        run: flutter pub get
        
      - name: Download Rust Backend
        uses: actions/download-artifact@v4
        with:
          name: bibliogenius-linux-x64
          path: backend

      - name: Build Linux app
        run: flutter build linux --release

      - name: Inject Rust Binary
        run: |
          mkdir -p build/linux/x64/release/bundle/backend
          cp backend/bibliogenius build/linux/x64/release/bundle/backend/
          chmod +x build/linux/x64/release/bundle/backend/bibliogenius

      - name: Create tarball
        run: |
          cd build/linux/x64/release
          tar -czvf ../../../../BiblioGenius-Linux.tar.gz bundle/
          
      - name: Upload Linux app
        uses: actions/upload-artifact@v4
        with:
          name: bibliogenius-linux
          path: BiblioGenius-Linux.tar.gz

  # =============================================================================
  # CREATE GITHUB RELEASE
  # =============================================================================
  release:
    needs: [build-android, build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: "!contains(github.ref, '-ci')"
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Display structure
        run: ls -R artifacts
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: true
          generate_release_notes: false
          body: |
            # BiblioGenius ${{ github.ref_name }} "Sovereign Librarian"
            
            ğŸ‰ **Release!**
            
            ## âœ¨ Features
            - ğŸ“š Complete book catalog management (ISBN scan, manual entry)
            - ğŸ”„ Local network synchronization (LAN/mDNS)
            - ğŸ¤ Peer-to-peer book sharing with friends
            - ğŸ† Gamification system with badges and levels
            - ğŸ“± Cross-platform: macOS, Windows, Linux, Android
            
            ## ğŸ“¥ Downloads
            
            | Platform | Status | File |
            |----------|--------|------|
            | **macOS** | âœ… Tested | `BiblioGenius-macOS.dmg` |
            | **Android** | âœ… Tested | `app-release.apk` |
            | **Windows** | âš ï¸ Untested | `BiblioGenius-Windows.zip` |
            | **Linux** | âš ï¸ Untested | `BiblioGenius-Linux.tar.gz` |
            
            > âš ï¸ **Note**: Windows and Linux builds are automated but not manually tested. Please report any issues!
            
            ## ğŸš€ Getting Started
            
            1. Download the appropriate file for your platform
            2. **macOS**: 
               - Open the .dmg, drag to Applications
               - **Important**: The app is unsigned. To run it, open Terminal and execute:
                 ```bash
                 xattr -cr /Applications/bibliogenius.app
                 ```
               - Then launch the app normally from Applications
            3. **Android**: Enable "Install from unknown sources", install APK
            4. **Windows**: Extract ZIP, run `bibliogenius.exe`
            5. **Linux**: Extract tarball, run `./bibliogenius`
            
            ## ğŸ› Known Limitations
            - P2P works on local network only (global P2P coming in v2.0)
            - No iOS build (requires Apple Developer account)
            - **macOS app is unsigned**: You must remove quarantine flag with `xattr -cr` (see instructions above)
            
            ## ğŸ“ Feedback
            Please report issues on [GitHub Issues](https://github.com/bibliogenius/bibliogenius-app/issues)
            
          files: |
            artifacts/bibliogenius-macos/*
            artifacts/bibliogenius-android/*
            artifacts/bibliogenius-windows/*
            artifacts/bibliogenius-linux/*
