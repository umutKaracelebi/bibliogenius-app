name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # Allows manual trigger for testing

env:
  FLUTTER_VERSION: '3.38.4'

jobs:
  # =============================================================================
  # BUILD RUST BACKEND
  # =============================================================================
  build-rust:
    strategy:
      matrix:
        include:
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: bibliogenius-macos-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: bibliogenius-macos-arm64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: bibliogenius-linux-x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: bibliogenius-windows-x64

    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          repository: bibliogenius/bibliogenius
          
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libsqlite3-dev libssl-dev
          
      - name: Build Rust backend
        run: cargo build --release --target ${{ matrix.target }}
        
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            target/${{ matrix.target }}/release/bibliogenius
            target/${{ matrix.target }}/release/bibliogenius.exe

  # =============================================================================
  # BUILD FLUTTER APP (all platforms use default checkout + clone Rust repo)
  # =============================================================================
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space (Ubuntu)
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android/sdk/ndk
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

      - uses: actions/checkout@v4
      
      # Clone Rust repo at expected path (3 levels up from rust_builder subdirs)
      - name: Clone Rust repository
        run: git clone https://github.com/bibliogenius/bibliogenius.git ../bibliogenius
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r25c
          add-to-path: true

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          
      - name: Accept Android Licenses
        run: yes | flutter doctor --android-licenses || true

      - name: Create key.properties
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          # Decode keystore
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/app/release-key.jks
          
          # Create key.properties
          echo "storePassword=$ANDROID_KEYSTORE_PASSWORD" > android/key.properties
          echo "keyPassword=$ANDROID_KEY_PASSWORD" >> android/key.properties
          echo "keyAlias=$ANDROID_KEY_ALIAS" >> android/key.properties
          echo "storeFile=release-key.jks" >> android/key.properties

      - name: Create .env file
        run: cp .env.example .env

      - name: Get dependencies
        run: flutter pub get
        
      - name: Build Android App Bundle
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          flutter build apk --release
          BUILD_NUMBER=$((${{ github.run_number }} + 200))
          flutter build appbundle --release --build-number=$BUILD_NUMBER

      - name: Upload APK & AAB
        uses: actions/upload-artifact@v4
        with:
          name: bibliogenius-android
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab

      - name: Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.ANDROID_SERVICE_ACCOUNT_JSON }}
          packageName: com.bibliogenius.app
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: internal
          status: draft

  build-macos:
    needs: build-rust
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      # Clone Rust repo into rust_builder (same approach as Linux/Windows)
      - name: Clone Rust repository
        run: git clone https://github.com/bibliogenius/bibliogenius.git rust_builder/bibliogenius
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false

      - name: Install CocoaPods
        run: gem install cocoapods
          
      - name: Create .env file
        run: cp .env.example .env

      - name: Get dependencies
        run: flutter pub get
        
      - name: Download Rust Backend (x64)
        uses: actions/download-artifact@v4
        with:
          name: bibliogenius-macos-x64
          path: backend-x64

      - name: Download Rust Backend (ARM64)
        uses: actions/download-artifact@v4
        with:
          name: bibliogenius-macos-arm64
          path: backend-arm64

      - name: Import Developer ID Certificate
        env:
          # CRITICAL: Use Developer ID for macOS DMG, separate from iOS Apple Distribution
          APPLE_CERTIFICATE_BASE64: ${{ secrets.MACOS_DEVELOPER_ID_CERT_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Import certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          
          # Store keychain path for later
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

          # Download and Import Apple WWDR Intermediate (G3 and G4) and Developer ID CA
          # This ensures the chain is complete for the Developer ID certificate
          curl -LO https://www.apple.com/certificateauthority/AppleWWDRCAG3.cer
          curl -LO https://www.apple.com/certificateauthority/AppleWWDRCAG4.cer
          curl -LO https://www.apple.com/certificateauthority/DeveloperIDCA.cer
          
          # Import trusted intermediates (ignore errors if already present)
          security import AppleWWDRCAG3.cer -k $KEYCHAIN_PATH -t agg || true
          security import AppleWWDRCAG4.cer -k $KEYCHAIN_PATH -t agg || true
          security import DeveloperIDCA.cer -k $KEYCHAIN_PATH -t agg || true

      - name: Import Apple Distribution Certificate
        env:
          # Apple Distribution certificate for TestFlight/App Store builds
          APPLE_CERT_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo "$APPLE_CERT_BASE64" | base64 --decode > $RUNNER_TEMP/apple_dist_cert.p12
          security import $RUNNER_TEMP/apple_dist_cert.p12 -P "$APPLE_CERT_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -s -k "$(openssl rand -base64 32)" $KEYCHAIN_PATH || true
          echo "Available signing identities:"
          security find-identity -v -p codesigning $KEYCHAIN_PATH

      - name: Install Installer Certificate
        env:
          MACOS_INSTALLER_CERT_BASE64: ${{ secrets.MACOS_INSTALLER_CERT_BASE64 }}
          MACOS_INSTALLER_CERT_PASSWORD: ${{ secrets.MACOS_INSTALLER_CERT_PASSWORD }}
        run: |
          echo "$MACOS_INSTALLER_CERT_BASE64" | base64 --decode > $RUNNER_TEMP/installer_cert.p12
          security import $RUNNER_TEMP/installer_cert.p12 -P "$MACOS_INSTALLER_CERT_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

      - name: Install Provisioning Profile
        env:
          APPLE_PROVISION_PROFILE_BASE64: ${{ secrets.APPLE_PROVISION_PROFILE_BASE64 }}
        run: |
          # Create directory
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          # Decode profile
          echo "$APPLE_PROVISION_PROFILE_BASE64" | base64 --decode > $RUNNER_TEMP/profile.mobileprovision

          # Extract UUID
          UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< $(security cms -D -i $RUNNER_TEMP/profile.mobileprovision))
          echo "Profile UUID: $UUID"
          
          # Copy to directory
          cp $RUNNER_TEMP/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          
          # Export UUID for next step
          echo "PROFILE_UUID=$UUID" >> $GITHUB_ENV

      - name: Build macOS app (signed for App Store/TestFlight)
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Update project with correct team ID and signing settings
          sed -i '' "s/DEVELOPMENT_TEAM = RF374CUSUZ/DEVELOPMENT_TEAM = $APPLE_TEAM_ID/g" macos/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' macos/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/"Apple Development"/"Apple Distribution"/g' macos/Runner.xcodeproj/project.pbxproj
          sed -i '' "s/PROVISIONING_PROFILE_SPECIFIER = \"\";/PROVISIONING_PROFILE_SPECIFIER = \"$PROFILE_UUID\";/g" macos/Runner.xcodeproj/project.pbxproj
          
          # Build the app with Apple Distribution signing (for TestFlight/App Store)
          flutter build macos --release
      
      - name: Validate app bundle
        run: |
          APP_PATH="build/macos/Build/Products/Release/bibliogenius.app"
          
          # Check essential files exist
          if [ ! -f "$APP_PATH/Contents/Info.plist" ]; then
            echo "‚ùå ERROR: Info.plist missing!"
            ls -la "$APP_PATH/Contents" || echo "Contents directory doesn't exist"
            exit 1
          fi
          
          if [ ! -f "$APP_PATH/Contents/MacOS/bibliogenius" ]; then
            echo "‚ùå ERROR: Main executable missing!"
            ls -la "$APP_PATH/Contents/MacOS" || echo "MacOS directory doesn't exist"
            exit 1
          fi
          
          echo "‚úÖ App bundle validation passed"
          echo "App bundle structure:"
          ls -la "$APP_PATH/Contents"

      - name: Inject Rust Binary
        run: |
          ARCH=$(uname -m)
          mkdir -p build/macos/Build/Products/Release/bibliogenius.app/Contents/Resources/backend
          if [ "$ARCH" == "arm64" ]; then
            cp backend-arm64/bibliogenius build/macos/Build/Products/Release/bibliogenius.app/Contents/Resources/backend/
          else
            cp backend-x64/bibliogenius build/macos/Build/Products/Release/bibliogenius.app/Contents/Resources/backend/
          fi
          chmod +x build/macos/Build/Products/Release/bibliogenius.app/Contents/Resources/backend/bibliogenius

      # === TESTFLIGHT UPLOAD (before Developer ID re-signing) ===
      # The app is already signed with Apple Distribution from flutter build
      
      - name: Sign Backend for App Store
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          APP_PATH="build/macos/Build/Products/Release/bibliogenius.app"
          BACKEND_PATH="$APP_PATH/Contents/Resources/backend/bibliogenius"
          
          # Find Apple Distribution identity for App Store
          APPLE_DIST=$(security find-identity -v -p codesigning | grep "Apple Distribution" | head -1 | awk -F '"' '{print $2}')
          
          if [ -z "$APPLE_DIST" ]; then
            echo "‚ùå Error: Apple Distribution certificate not found"
            security find-identity -v -p codesigning
            exit 1
          fi
          
          echo "Signing backend with Apple Distribution for TestFlight: $APPLE_DIST"
          
          # Prepare entitlements
          sed "s/\$(AppIdentifierPrefix)/$APPLE_TEAM_ID./g" macos/Runner/Release.entitlements > macos/Runner/Release.processed.entitlements
          
          # Sign the injected backend binary with Apple Distribution
          codesign --force --verbose --timestamp --options runtime --sign "$APPLE_DIST" --entitlements macos/Runner/Release.processed.entitlements "$BACKEND_PATH"
          
          # Re-sign the main app bundle to include the new backend
          codesign --force --verbose --timestamp --options runtime --sign "$APPLE_DIST" --entitlements macos/Runner/Release.processed.entitlements "$APP_PATH"
          
          echo "‚úÖ App signed with Apple Distribution for TestFlight"
          codesign -dvv "$APP_PATH"

      - name: Create Signed PKG for TestFlight
        run: |
          APP_PATH="build/macos/Build/Products/Release/bibliogenius.app"
          
          INSTALLER_IDENTITY=$(security find-identity -v | grep "3rd Party Mac Developer Installer" | head -1 | awk -F '"' '{print $2}')
          
          if [ -z "$INSTALLER_IDENTITY" ]; then
            echo "Error: No '3rd Party Mac Developer Installer' identity found."
            security find-identity -v
            exit 1
          fi
          
          echo "Found Installer Identity: $INSTALLER_IDENTITY"
          productbuild --component "$APP_PATH" /Applications --sign "$INSTALLER_IDENTITY" "bibliogenius-testflight.pkg"
          echo "‚úÖ PKG created for TestFlight"

      - name: Decode Auth Key for TestFlight
        run: |
          mkdir -p private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-type: osx
          app-path: bibliogenius-testflight.pkg
          issuer-id: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          api-key-id: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          api-private-key: private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

      # === DMG DISTRIBUTION (with Developer ID for notarization) ===
        
      - name: Decode Auth Key
        run: |
          mkdir -p private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

      - name: Sign macOS App for Distribution
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          APP_PATH="build/macos/Build/Products/Release/bibliogenius.app"
          BACKEND_PATH="$APP_PATH/Contents/Resources/backend/bibliogenius"
          
          echo "Listing compiled directory:"
          ls -R build/macos/Build/Products/Release/
          
          # Check for Developer ID Application certificate (for notarized DMG)
          DEVELOPER_ID=$(security find-identity -v -p codesigning | grep "Developer ID Application" | head -1 | awk -F '"' '{print $2}')
          
          # Check for Apple Distribution certificate (for TestFlight/App Store)
          APPLE_DIST=$(security find-identity -v -p codesigning | grep "Apple Distribution" | head -1 | awk -F '"' '{print $2}')
          
          echo "Available identities:"
          security find-identity -v -p codesigning
          
          if [ -n "$DEVELOPER_ID" ]; then
            echo "‚úÖ Found Developer ID: $DEVELOPER_ID"
            echo "Will create notarized DMG for direct distribution"
            IDENTITY="$DEVELOPER_ID"
            echo "HAS_DEVELOPER_ID=true" >> $GITHUB_ENV
          elif [ -n "$APPLE_DIST" ]; then
            echo "‚ö†Ô∏è Developer ID not found, using Apple Distribution: $APPLE_DIST"
            echo "DMG will NOT be notarized (use TestFlight for distribution)"
            IDENTITY="$APPLE_DIST"
            echo "HAS_DEVELOPER_ID=false" >> $GITHUB_ENV
          else
            echo "‚ùå No valid signing identity found!"
            exit 1
          fi
          
          echo "Using identity: $IDENTITY"
          
          echo "Prepare entitlements..."
          sed "s/\$(AppIdentifierPrefix)/$APPLE_TEAM_ID./g" macos/Runner/Release.entitlements > macos/Runner/Release.processed.entitlements
          
          echo "Signing inner libraries and frameworks..."
          find "$APP_PATH/Contents/Frameworks" -depth \( -name "*.framework" -o -name "*.dylib" \) | while read file; do
             echo "Signing $file..."
             codesign --force --verbose --timestamp --options runtime --sign "$IDENTITY" "$file"
          done
          
          echo "Signing backend binary with hardened runtime and entitlements..."
          codesign --force --verbose --timestamp --options runtime --sign "$IDENTITY" --entitlements macos/Runner/Release.processed.entitlements "$BACKEND_PATH"
          
          echo "Signing main app bundle with hardened runtime and entitlements..."
          codesign --force --verbose --timestamp --options runtime --sign "$IDENTITY" --entitlements macos/Runner/Release.processed.entitlements "$APP_PATH"
          
          # Verify signing
          echo "Verifying signature..."
          codesign --verify --verbose --deep --strict "$APP_PATH"
          spctl --assess --verbose "$APP_PATH" || echo "spctl assessment note: may require notarization for Gatekeeper"

      - name: Create DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "BiblioGenius" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 450 185 \
            "BiblioGenius-macOS.dmg" \
            "build/macos/Build/Products/Release/bibliogenius.app" || true
          
          # Fallback to verify DMG creation
          if [ ! -f "BiblioGenius-macOS.dmg" ]; then
            echo "DMG creation failed, attempting zip fallback..."
            cd build/macos/Build/Products/Release
            zip -r ../../../../../BiblioGenius-macOS.zip bibliogenius.app
          fi

      - name: Notarize DMG
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          if [ "$HAS_DEVELOPER_ID" != "true" ]; then
            echo "‚ö†Ô∏è Skipping notarization - Developer ID Application certificate not available"
            echo "DMG will be uploaded unsigned. Users can run: xattr -cr /Applications/bibliogenius.app"
            echo "For notarized DMG, add Developer ID Application certificate to MACOS_DEVELOPER_ID_CERT_BASE64"
            exit 0
          fi
          
          if [ -f "BiblioGenius-macOS.dmg" ]; then
            echo "Notarizing DMG..."
            
            # Submit and capture output to get submission ID
            SUBMIT_OUTPUT=$(xcrun notarytool submit "BiblioGenius-macOS.dmg" \
              --key-id "$API_KEY_ID" \
              --issuer "$ISSUER_ID" \
              --key "private_keys/AuthKey_$API_KEY_ID.p8" \
              --wait \
              --output-format json 2>&1) || true
            
            echo "Submission output:"
            echo "$SUBMIT_OUTPUT"
            
            # Extract submission ID and status
            SUBMISSION_ID=$(echo "$SUBMIT_OUTPUT" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
            STATUS=$(echo "$SUBMIT_OUTPUT" | grep -o '"status":"[^"]*"' | tail -1 | cut -d'"' -f4)
            
            echo "Submission ID: $SUBMISSION_ID"
            echo "Status: $STATUS"
            
            if [ "$STATUS" == "Accepted" ]; then
              echo "‚úÖ Notarization successful!"
              echo "Stapling ticket to DMG..."
              xcrun stapler staple "BiblioGenius-macOS.dmg"
            else
              echo "‚ùå Notarization failed with status: $STATUS"
              echo "Fetching detailed log..."
              
              if [ -n "$SUBMISSION_ID" ]; then
                xcrun notarytool log "$SUBMISSION_ID" \
                  --key-id "$API_KEY_ID" \
                  --issuer "$ISSUER_ID" \
                  --key "private_keys/AuthKey_$API_KEY_ID.p8" \
                  notarization_log.json || true
                
                echo "=== NOTARIZATION LOG ==="
                cat notarization_log.json || echo "Could not read log"
                echo "========================"
              fi
              
              echo "‚ö†Ô∏è Continuing without stapling (DMG will still work with xattr -cr)"
            fi
          else
            echo "Skipping Notarization (DMG not found)"
          fi

      - name: Upload macOS app
        uses: actions/upload-artifact@v4
        with:
          name: bibliogenius-macos
          path: |
            BiblioGenius-macOS.dmg
            BiblioGenius-macOS.zip


  build-ios:
    needs: build-rust
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      # Clone Rust repo into rust_builder
      - name: Clone Rust repository
        run: git clone https://github.com/bibliogenius/bibliogenius.git rust_builder/bibliogenius
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
           targets: aarch64-apple-ios

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false

      - name: Install CocoaPods
        run: gem install cocoapods
          
      - name: Create .env file
        run: cp .env.example .env

      - name: Get dependencies
        run: flutter pub get
        
      - name: Download Rust Backend (ARM64)
        uses: actions/download-artifact@v4
        with:
          name: bibliogenius-macos-arm64
          path: backend-arm64

      - name: Import Apple Certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Import certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          
          # Store keychain path for later
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

      - name: Install iOS Provisioning Profile
        env:
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$IOS_PROVISION_PROFILE_BASE64" | base64 --decode > $RUNNER_TEMP/profile.mobileprovision
          UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< $(security cms -D -i $RUNNER_TEMP/profile.mobileprovision))
          cp $RUNNER_TEMP/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          echo "PROFILE_UUID=$UUID" >> $GITHUB_ENV

      - name: Create ExportOptions.plist
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cat <<EOF > ios/Runner/ExportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>$APPLE_TEAM_ID</string>
              <key>provisioningProfiles</key>
              <dict>
                <key>com.bibliogenius.app</key>
                <string>$PROFILE_UUID</string>
              </dict>
              <key>manageAppVersionAndBuildNumber</key>
              <true/>
              <key>stripSwiftSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
          </dict>
          </plist>
          EOF

      - name: Build iOS app (IPA)
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Force manual signing and update team ID
          sed -i '' "s/DEVELOPMENT_TEAM = RF374CUSUZ/DEVELOPMENT_TEAM = $APPLE_TEAM_ID/g" ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_STYLE = Automatic/CODE_SIGN_STYLE = Manual/g' ios/Runner.xcodeproj/project.pbxproj
          
          # Insert PROVISIONING_PROFILE_SPECIFIER after DEVELOPMENT_TEAM since it doesn't exist
          sed -i '' "s/DEVELOPMENT_TEAM = $APPLE_TEAM_ID;/DEVELOPMENT_TEAM = $APPLE_TEAM_ID; PROVISIONING_PROFILE_SPECIFIER = \"$PROFILE_UUID\";/g" ios/Runner.xcodeproj/project.pbxproj

          # FORCE BUNDLE ID to com.bibliogenius.app (to match Apple ID)
          sed -i '' 's/org.bibliogenius.app/com.bibliogenius.app/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/PRODUCT_BUNDLE_IDENTIFIER = org.bibliogenius.app;/PRODUCT_BUNDLE_IDENTIFIER = com.bibliogenius.app;/g' ios/Runner.xcodeproj/project.pbxproj
          
          # Force Distribution Identity
          sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = "iPhone Developer"/"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = "iPhone Distribution"/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_IDENTITY = "Apple Development"/CODE_SIGN_IDENTITY = "Apple Distribution"/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer"/CODE_SIGN_IDENTITY = "iPhone Distribution"/g' ios/Runner.xcodeproj/project.pbxproj
          
          # Debug: show what we changed
          echo "Profile UUID: $PROFILE_UUID"
          echo "Team ID: $APPLE_TEAM_ID"
          grep -C 5 "PROVISIONING_PROFILE_SPECIFIER" ios/Runner.xcodeproj/project.pbxproj || echo "Profile Specifier not found in file!"
          
          # Build IPA
          flutter build ipa --release --export-options-plist=ios/Runner/ExportOptions.plist

      - name: Debug Build Directory
        if: always()
        run: ls -R build/ios || echo "build/ios not found"

      - name: Decode Auth Key
        run: |
          mkdir -p private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

      - name: Find IPA File
        id: find_ipa
        run: |
          IPA_PATH=$(find build/ios/ipa -name "*.ipa" -maxdepth 1 | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "‚ùå No IPA file found in build/ios/ipa/"
            exit 1
          fi
          echo "‚úÖ Found IPA at: $IPA_PATH"
          echo "IPA_PATH=$IPA_PATH" >> $GITHUB_ENV

      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: ${{ env.IPA_PATH }}
          issuer-id: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          api-key-id: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          api-private-key: private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

  build-windows:
    needs: build-rust
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      # Clone Rust repo locally - CMakeLists.txt uses CMAKE_SOURCE_DIR to find it
      - name: Clone Rust repository
        run: git clone https://github.com/bibliogenius/bibliogenius.git rust_builder/bibliogenius

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          
      - name: Create .env file
        run: copy .env.example .env

      - name: Get dependencies
        run: flutter pub get
        
      - name: Download Rust Backend
        uses: actions/download-artifact@v4
        with:
          name: bibliogenius-windows-x64
          path: backend

      - name: Build Windows app
        run: flutter build windows --release

      - name: Inject Rust Binary
        run: |
          mkdir build\windows\x64\runner\Release\backend
          copy backend\bibliogenius.exe build\windows\x64\runner\Release\backend\
        
      - name: Create ZIP
        run: |
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath BiblioGenius-Windows.zip
          
      - name: Upload Windows app
        uses: actions/upload-artifact@v4
        with:
          name: bibliogenius-windows
          path: BiblioGenius-Windows.zip

  build-linux:
    needs: build-rust
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Clone Rust repo locally - CMakeLists.txt uses CMAKE_SOURCE_DIR to find it
      - name: Clone Rust repository
        run: git clone https://github.com/bibliogenius/bibliogenius.git rust_builder/bibliogenius

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libglu1-mesa-dev libstdc++-12-dev libsecret-1-dev libsqlite3-dev libssl-dev

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          
      - name: Create .env file
        run: cp .env.example .env

      - name: Get dependencies
        run: flutter pub get
        
      - name: Download Rust Backend
        uses: actions/download-artifact@v4
        with:
          name: bibliogenius-linux-x64
          path: backend

      - name: Build Linux app
        run: flutter build linux --release

      - name: Inject Rust Binary
        run: |
          mkdir -p build/linux/x64/release/bundle/backend
          cp backend/bibliogenius build/linux/x64/release/bundle/backend/
          chmod +x build/linux/x64/release/bundle/backend/bibliogenius

      - name: Create tarball
        run: |
          cd build/linux/x64/release
          tar -czvf ../../../../BiblioGenius-Linux.tar.gz bundle/
          
      - name: Upload Linux app
        uses: actions/upload-artifact@v4
        with:
          name: bibliogenius-linux
          path: BiblioGenius-Linux.tar.gz

  # =============================================================================
  # CREATE GITHUB RELEASE
  # =============================================================================
  release:
    needs: [build-android, build-macos, build-ios, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: "!contains(github.ref, '-ci')"
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Display structure
        run: ls -R artifacts
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: true
          generate_release_notes: false
          body: |
            # BiblioGenius ${{ github.ref_name }} "Sovereign Librarian"
            
            üéâ **Release!**
            
            ## ‚ú® Features
            - üìö Complete book catalog management (ISBN scan, manual entry)
            - üîÑ Local network synchronization (LAN/mDNS)
            - ü§ù Peer-to-peer book sharing with friends
            - üèÜ Gamification system with badges and levels
            - üì± Cross-platform: macOS, Windows, Linux, Android
            
            ## üì• Downloads
            
            | Platform | Status | File |
            |----------|--------|------|
            | **macOS** | ‚úÖ Tested | `BiblioGenius-macOS.dmg` |
            | **Android** | ‚úÖ Tested | `app-release.apk` |
            | **Windows** | ‚ö†Ô∏è Untested | `BiblioGenius-Windows.zip` |
            | **Linux** | ‚ö†Ô∏è Untested | `BiblioGenius-Linux.tar.gz` |
            
            > ‚ö†Ô∏è **Note**: Windows and Linux builds are automated but not manually tested. Please report any issues!
            
            ## üöÄ Getting Started
            
            1. Download the appropriate file for your platform
            2. **macOS**: 
               - Open the .dmg, drag to Applications
               - **Important**: The app is unsigned. To run it, open Terminal and execute:
                 ```bash
                 xattr -cr /Applications/bibliogenius.app
                 ```
               - Then launch the app normally from Applications
            3. **Android**: Enable "Install from unknown sources", install APK
            4. **Windows**: Extract ZIP, run `bibliogenius.exe`
            5. **Linux**: Extract tarball, run `./bibliogenius`
            
            ## üêõ Known Limitations
            - P2P works on local network only (global P2P coming in v2.0)
            - No iOS build (requires Apple Developer account)
            - **macOS app is unsigned**: You must remove quarantine flag with `xattr -cr` (see instructions above)
            
            ## üìù Feedback
            Please report issues on [GitHub Issues](https://github.com/bibliogenius/bibliogenius-app/issues)
            
          files: |
            artifacts/bibliogenius-macos/*
            artifacts/bibliogenius-android/*
            artifacts/bibliogenius-windows/*
            artifacts/bibliogenius-linux/*
