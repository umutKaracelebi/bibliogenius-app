import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';
import '../providers/theme_provider.dart';
import '../services/api_service.dart';

class TranslationService {
  static Map<String, Map<String, String>> _dynamicTranslations = {};
  static const String _storageKey = 'cached_translations';

  static Future<void> loadFromCache() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final String? cached = prefs.getString(_storageKey);
      if (cached != null) {
        final Map<String, dynamic> decoded = json.decode(cached);
        _dynamicTranslations = decoded.map((key, value) => 
          MapEntry(key, Map<String, String>.from(value as Map))
        );
      }
    } catch (e) {
      debugPrint('Error loading cached translations: $e');
    }
  }

  static Future<void> fetchTranslations(BuildContext context) async {
    try {
      final themeProvider = Provider.of<ThemeProvider>(context, listen: false);
      final api = Provider.of<ApiService>(context, listen: false);
      final locale = themeProvider.locale.languageCode;

      final response = await api.getTranslations(locale);
      if (response.statusCode == 200) {
        final Map<String, dynamic> data = response.data;
        final Map<String, String> newTranslations = data.map((k, v) => MapEntry(k, v.toString()));
        
        _dynamicTranslations[locale] = {
          ...(_dynamicTranslations[locale] ?? {}),
          ...newTranslations,
        };

        // Cache
        final prefs = await SharedPreferences.getInstance();
        await prefs.setString(_storageKey, json.encode(_dynamicTranslations));
      }
    } catch (e) {
      debugPrint('Error fetching translations: $e');
    }
  }

  static final Map<String, Map<String, String>> _localizedValues = {
    'en': {
      'app_title': 'BiblioGenius',
      'app_subtitle': 'Smart Library Manager',
      'dashboard': 'Dashboard',
      'home': 'Home',
      'library': 'Library',
      'contacts': 'Contacts',
      'p2p': 'P2P',
      'network': 'Network',
      'requests': 'Requests',
      'books': 'Books',
      'profile': 'My Profile',
      'librarian': 'Librarian',
      'individual': 'Individual',
      'professional': 'Professional',
      'loans': 'Loans',
      'edits': 'Edits',
      'next_level_progress': 'Next Level Progress',
      'to_next_level': 'to next level',
      'profile_settings': 'Profile Settings',
      'profile_type': 'Profile Type',
      'show_borrowed_books': 'Show borrowed books',
      'show_borrowed_subtitle': 'Include borrowed books in your library view',
      'data_management': 'Data Management',
      'export_backup': 'Export Library Backup',
      'import_csv': 'Import from Goodreads/LibraryThing',
      'app_settings': 'App Settings',
      'logout': 'Logout',
      'customize_avatar': 'Customize Avatar',
      'save_changes': 'Save Changes',
      'cancel': 'Cancel',
      'edit_settings': 'Edit Settings',
      'settings_dialog_title': 'Edit App Settings',
      'settings_dialog_body': 'Do you want to modify your app settings? This will take you to the setup wizard to update your theme and library preferences.',
      'settings_dialog_body': 'Do you want to modify your app settings? This will take you to the setup wizard to update your theme and library preferences.',
      'lang_title': 'Language',
      'theme_title': 'Theme',
      'library_name': 'Library Name',
      'edit_library_name': 'Edit Library Name',
      'library_updated': 'Library name updated successfully',
      'error_updating_library': 'Error updating library name',
      'reset_app': 'Reset Application',
      'reset_app_title': 'Reset Application',
      'reset_app_confirmation': 'Are you sure you want to reset the application? This will clear all local data and return you to the setup wizard.',
      'reset_confirm': 'Reset Everything',
      'import_success': 'Successfully imported books!',
      'import_fail': 'Import failed',
      'export_success': 'Backup prepared',
      'export_fail': 'Export failed',
      'error': 'Error',
      'no_data': 'No data',
      'borrow_requests_title': 'Borrow Requests',
      'tab_incoming': 'Incoming',
      'tab_outgoing': 'Outgoing',
      'tab_connections': 'Connections',
      'no_incoming_requests': 'No incoming requests',
      'no_outgoing_requests': 'No outgoing requests',
      'no_pending_connections': 'No pending connection requests',
      'incoming_connections': 'Incoming Connections',
      'outgoing_connections': 'Outgoing Connections',
      'unknown_library': 'Unknown Library',
      'unknown_book': 'Unknown Book',
      'from': 'From',
      'to': 'To',
      'status_pending': 'PENDING',
      'status_accepted': 'ACCEPTED',
      'status_rejected': 'REJECTED',
      'status_returned': 'RETURNED',
      'btn_accept': 'Accept',
      'btn_reject': 'Reject',
      'btn_mark_returned': 'Mark Returned',
      'btn_cancel_request': 'Cancel Request',
      'btn_remove': 'Remove',
      'dialog_delete_title': 'Delete Request',
      'dialog_delete_body': 'Are you sure you want to delete this request?',
      'dialog_delete_confirm': 'Delete',
      'snack_error_fetching': 'Error fetching requests',
      'snack_error_updating': 'Error updating status',
      'snack_connection_updated': 'Connection updated',
      'p2p_title': 'Connect Library',
      'tab_share_code': 'Share Code',
      'tab_scan_code': 'Scan Code',
      'qr_error': 'Could not generate QR Code.',
      'retry': 'Retry',
      'scan_to_connect': 'Scan to connect',
      'share_code_instruction': 'Show this code to another user to let them connect to your library.',
      'scan_instruction': 'Align QR code within the frame',
      'connected_to': 'Connected to',
      'connection_failed': 'Failed to connect',
      'network_libraries_title': 'Network Libraries',
      'manual_connection_title': 'Debug: Manual Connection',
      'library_url': 'Library URL',
      'connect': 'Connect',
      'added_from_network': 'Added from network',
      'added_to_contacts': 'Added to contacts',
      'added_to_borrowers': 'Added to borrowers',
      'error_adding': 'Error adding',
      'status_waiting': 'Waiting',
      'request_sent': 'Request sent',
      'tooltip_cancel_request': 'Cancel request',
      'tooltip_sync': 'Sync Library',
      'sync_started': 'Sync started',
      'tooltip_add_contact': 'Add to contacts',
      'tooltip_remove_library': 'Remove Library',
      'library_not_accepted': 'This library has not accepted your request yet',
      'dialog_remove_library_title': 'Remove Library',
      'dialog_remove_library_body': 'Are you sure you want to remove this library from your network?',
      'library_removed': 'Library removed successfully',
      'error_removing': 'Error removing library',
      'total_books': 'Total Books',
      'active_loans': 'Active Loans',
      'welcome_title': 'Welcome to BiblioGenius!',
      'welcome_subtitle': 'Your library is looking a bit empty. Start by adding your first book or searching online.',
      'btn_add_manually': 'Add Manually',
      'btn_search_online': 'Search Online',
      'quick_actions': 'Quick Actions',
      'action_add_book': 'Add Book',
      'action_checkout_book': 'Checkout Book',
      'action_search_remote': 'Search Remote',
      'action_ask_library': 'Ask Library',
      'recent_books': 'Recent Books',
      'no_recent_books': 'No recent books',
      'reading_list': 'Reading List',
      'no_reading_list': 'No books in reading list',
      'view_insights': 'View Library Insights',
      'unknown_author': 'Unknown Author',
      'btn_details': 'Details',
      'my_library_title': 'My Library',
      'search_books': 'Search Books',
      'scan_isbn': 'Scan ISBN',
      'search_hint': 'Search books...',
      'book_details_found': 'Book details found!',
      'book_updated': 'Book updated successfully',
      'error_updating_book': 'Error updating book',
      'delete_book_title': 'Delete Book',
      'delete_book_confirm': 'Are you sure you want to delete this book?',
      'delete_book_btn': 'Delete Book',
      'cancel': 'Cancel',
      'error_deleting_book': 'Error deleting book',
      'summary_label': 'Summary',
      'no_summary': 'No summary available.',
      'borrowed_label': 'Borrowed',
      'lend_book_label': 'Lend Book',
      'no_copies_title': 'No Copies Found',
      'no_copies_confirm': 'This book has no copies. Create a new copy to lend?',
      'create_lend_btn': 'Create & Lend',
      'failed_create_copy': 'Failed to create copy.',
      'all_copies_lent': 'All copies are currently lent out.',
      'book_lent_to': 'Book lent to',
      'error_lending_book': 'Error lending book',
      'currently_reading': 'Currently Reading',
      'read_status': 'Read',
      'wishlist_status': 'Wishlist',
      'to_read_status': 'To Read',
      'edit_book_title': 'Edit Book',
      'edit_book_details': 'Edit Book Details',
      'title_label': 'Title *',
      'enter_book_title': 'Enter book title',
      'enter_title_error': 'Please enter a title',
      'isbn_label': 'ISBN',
      'enter_isbn': 'Enter ISBN',
      'publisher_label': 'Publisher',
      'publisher_hint': 'Publisher name',
      'year_label': 'Year',
      'year_hint': 'YYYY',
      'summary_hint': 'Brief summary of the book',
      'status_label': 'Status',
      'save_changes': 'Save Changes',
      'saving_changes': 'Saving Changes...',
      'add_book_title': 'Add Book',
      'add_new_book': 'Add a New Book',
      'author_label': 'Author',
      'author_hint': 'Author name',
      'enter_isbn_autofill': 'Enter ISBN to autofill',
      'lookup_isbn': 'Lookup ISBN',
      'save_book': 'Save Book',
      'saving': 'Saving...',
      'error_saving_book': 'Error saving book',
      'copies_title': 'Copies of',
      'copy_number': 'Copy #',
      'no_copies': 'No copies found',
      'book_summary': 'Summary',
      'book_deleted': 'Book deleted',
      'mark_as_finished': 'Mark as Finished',
      'finished_on': 'Finished on',
      'start_reading': 'Start Reading',
      'started_on': 'Started on',
      'reading_status_read': 'Read',
      'reading_status_reading': 'Reading',
      'reading_status_to_read': 'To Read', 
      'tags': 'Tags',
      'add_tag_hint': 'Add a tag...',
      'started_reading_label': 'Started Reading',
      'finished_reading_label': 'Finished Reading',
      'select_date': 'Select Date',
      'status_updated': 'Status updated',
      'date_select_title': 'Select Date',
      'date_select_option_today': 'Today',
      'date_select_option_pick': 'Pick a date',
      'date_select_option_none': 'No date',
      'filter_all': 'All',

      // App Drawer
      'nav_dashboard': 'Dashboard',
      'nav_my_library': 'My Library',
      'nav_contacts': 'Contacts',
      'nav_p2p': 'Connect',
      'nav_network': 'Network Libraries',
      'nav_requests': 'Borrow Requests',
      'nav_profile': 'My Profile',
      // Contacts Screen
      'delete_contact_title': 'Delete Contact',
      'delete_contact_confirm': 'Are you sure you want to delete this contact?',
      'delete_contact_btn': 'Delete',
      'contact_deleted': 'Contact deleted successfully',
      'error_deleting_contact': 'Error deleting contact',
      'error_loading_contacts': 'Error loading contacts',
      'filter_all_contacts': 'All Contacts',
      'filter_borrowers': 'Borrowers',
      'filter_libraries': 'Libraries',
      // Loan Dialog
      'lend_book_title': 'Lend Book',
      'no_borrowers_found': 'No borrowers found. Add a contact first.',
      'select_contact_lend': 'Select a contact to lend this book to:',
      'lend_btn': 'Lend',
      // Scan Screen
      'scan_isbn_title': 'Scan ISBN',
      'btn_enter_manually': 'Enter Manually',
      // External Search
      'external_search_title': 'External Book Search',
      'enter_search_term': 'Please enter at least one search term',
      'failed_add_book': 'Failed to add book',
      'search_open_library': 'Search Online',
      // Search Peer
      'request_sent_to': 'Request sent to',
      'connection_error': 'Connection error',
      'scan_qr_code': 'Or scan a QR Code',
      'already_connected': 'Already connected',
      'add_peer_btn': 'Add',
      'peer_search_hint': 'Ex: Thomas\'s Library',
      // Setup Screen
      'choose_profile_type': 'Choose Profile Type',
      'profile_usage_question': 'How will you use BiblioGenius?',
      'customize_avatar': 'Customize Avatar',
      'setup_failed': 'Setup failed',
      'lang_en': 'English',
      'lang_fr': 'French',
      'lang_es': 'Spanish',
      'lang_de': 'German',
      'theme_default': 'Default (Colorful)',
      'theme_minimal': 'Minimal (Clean)',
      // Login Screen
      'login_title': 'Login',
      'login_btn': 'Login',
      'new_server_setup': 'New Server? Run Setup',
      // Contact Details
      'contact_details_title': 'Contact Details',
      'edit_feature_soon': 'Edit feature coming soon',
      // Book List
      'menu_edit': 'Edit',
      'menu_manage_copies': 'Manage Copies',
      // Book Status
      'status_available': 'Available',
      'status_checked_out': 'Checked Out',
      'status_reference': 'Reference Only',
      'status_missing': 'Missing/Lost',
      'status_damaged': 'Damaged/Repair',
      'status_on_order': 'On Order',
      // Profiles
      'profile_librarian': 'Librarian',
      'profile_librarian_desc': 'Professional cataloging, lending management, and strict organization.',
      'profile_individual': 'Individual Reader',
      'profile_individual_desc': 'Track your reading, wishlists, and personal collection.',
      'profile_kid': 'Junior Reader',
      'profile_kid_desc': 'Fun interface, simple tracking, and cool avatars!',
      // Avatars
      'avatar_junior_reader': 'Junior Reader',
      'avatar_bookworm': 'Bookworm',
      'avatar_young_reader': 'Young Reader',
      'avatar_grandmother': 'Grandmother',
      'avatar_head_librarian': 'Head Librarian',
      'avatar_head_librarian': 'Head Librarian',
      'avatar_professional_librarian': 'Professional Librarian',
      // Badges
      'badge_pro': 'Pro',
      'badge_bibliogenius': 'BiblioGenius',
      'badge_member': 'Member',
      // Avatar Customizer
      'avatar_style': 'Avatar Style',
      'avatar_bg_color': 'Background Color',
      'avatar_expression': 'Expression',
      'avatar_hair': 'Hair',
      'avatar_facial_hair': 'Facial Hair',
      'avatar_skin_color': 'Skin Color',
      'avatar_hair_color': 'Hair Color',
      'avatar_accessories': 'Accessories',
      'avatar_clothing': 'Clothing',
      // Dashboard & Search
      'error_loading_dashboard': 'Error loading dashboard',
      'error_saving_avatar': 'Error saving avatar',
      'subject_label': 'Subject',
      'unknown_title': 'Unknown Title',
      'add_to_library_tooltip': 'Add to Library',
      'borrowers': 'Borrowers',
      'search_failed': 'Search failed',
      'added_to_library': 'added to library',
      // Statistics
      'library_insights': 'Library Insights',
      'no_books_analyze': 'No books to analyze yet!',
      'reading_habits': 'Reading Habits',
      'top_authors': 'Top Authors',
      'publication_timeline': 'Publication Timeline',
      'stat_total_books': 'Total Books',
      'stat_read': 'Read',
      'stat_borrowed': 'Borrowed',
      'stat_unique_authors': 'Unique Authors',
      'stat_completion': 'Completion',
      'stat_oldest_book': 'Oldest Book',
      'stat_avg_year': 'Avg Year',
      'stat_books_per_author': 'Books/Author',
      'wizard_menu_title': 'Main Menu',
      'wizard_menu_desc': 'Access your library, contacts, and settings here.',
      'wizard_add_title': 'Add Books',
      'wizard_add_desc': 'Scan a barcode or search online to add books.',
      'wizard_search_title': 'Search',
      'wizard_search_desc': 'Find books in your library or your friends\' libraries.',
      'wizard_stats_title': 'Quick Stats',
      'wizard_stats_desc': 'See how many books you have and who borrowed them.',
      'wizard_books_view_desc': 'Switch between grid view (bookshelf) and list view.',
    
    // Contacts Wizard
    'wizard_contacts_add_title': 'Add Contact',
    'wizard_contacts_add_desc': 'Add friends or borrowers to share books with.',
    'wizard_contacts_filter_title': 'Filter Contacts',
    'wizard_contacts_filter_desc': 'Filter by Borrowers (local) or Libraries (P2P).',
      'wizard_skip': 'Skip',
      
      // Onboarding Tour
      'onboarding_skip': 'Skip',
      'onboarding_next': 'Next',
      'onboarding_finish': 'Get Started',
      'onboarding_tap_continue': 'Tap anywhere to continue',
      'menu_tutorial': 'Tutorial',
      
      'onboarding_welcome_title': 'Welcome to BiblioGenius!',
      'onboarding_welcome_desc': 'Your personal library manager. Organize your books, connect with friends, and track your reading journey.',
      
      'onboarding_books_title': 'Manage Your Library',
      'onboarding_books_desc': 'Add books by scanning barcodes, searching online databases, or entering details manually. Keep track of everything you own.',
      
      'onboarding_p2p_title': 'Connect & Share',
      'onboarding_p2p_desc': 'Connect with other BiblioGenius users to share your libraries. See what your friends are reading and discover new books.',
      
      'onboarding_contacts_title': 'Track Borrowers',
      'onboarding_contacts_desc': 'Manage your contacts and keep track of who borrowed what. Never lose track of your books again.',
      
      'onboarding_stats_title': 'Monitor Your Collection',
      'onboarding_stats_desc': 'View statistics about your library, track reading habits, and see your collection grow over time.',
      'no_pub_year_data': 'No publication year data.',
      'nav_p2p_connect': 'Connect',
      'nav_help': 'Help',
      'help_title': 'Help & Support',
      'help_topic_add_book': 'How to add a book?',
      'help_desc_add_book': 'Go to "My Library" and tap the "+" button. You can scan a barcode or search by title/ISBN.',
      'help_topic_lend': 'How to lend a book?',
      'help_desc_lend': 'Find the book in your library, tap "Manage Copies", then "Lend". Select a contact to lend to.',
      'help_topic_connect': 'How to connect with friends?',
      'help_desc_connect': 'Go to "Connect Library" to share your QR code or scan a friend\'s code.',
      'add_contact_title': 'Add Contact',
      'contact_type_label': 'Type',
      'role_borrower': 'Borrower',
      'role_library': 'Library',
      'contact_name_label': 'Name *',
      'contact_name_required': 'Please enter a name',
      'contact_email_label': 'Email',
      'contact_email_invalid': 'Please enter a valid email',
      'contact_phone_label': 'Phone',
      'contact_address_label': 'Address',
      'contact_notes_label': 'Notes',
      'save_contact': 'Save Contact',
      'contact_created': 'Contact created successfully',
      'error_creating_contact': 'Error creating contact',
      'friends_libraries_title': 'Friends\' Libraries',
      'network_search_title': 'Borrow a Book',
      'network_search_hint': 'Search in your network...',
      'network_search_no_results': 'No books found in your network',
      'network_search_prompt': 'Search for books available in your friends\' libraries',
      'request_book_btn': 'Request',
    },
    'fr': {
      'app_title': 'BiblioGenius',
      'app_subtitle': 'Gestionnaire de bibliothèque intelligent',
      'dashboard': 'Tableau de bord',
      'home': 'Accueil',
      'library': 'Bibliothèque',
      'contacts': 'Contacts',
      'p2p': 'P2P',
      'network': 'Réseau',
      'requests': 'Demandes',
      'books': 'Livres',
      'profile': 'Mon Profil',
      'librarian': 'Bibliothécaire',
      'individual': 'Particulier',
      'professional': 'Professionnel',
      'loans': 'Prêts',
      'edits': 'Modifications',
      'next_level_progress': 'Progression',
      'to_next_level': 'pour le niveau suivant',
      'profile_settings': 'Paramètres du profil',
      'profile_type': 'Type de profil',
      'show_borrowed_books': 'Afficher les livres empruntés',
      'show_borrowed_subtitle': 'Inclure les livres empruntés dans la vue bibliothèque',
      'data_management': 'Gestion des données',
      'export_backup': 'Exporter une sauvegarde',
      'import_csv': 'Importer depuis Goodreads/Babelio',
      'app_settings': 'Paramètres de l\'application',
      'logout': 'Se déconnecter',
      'customize_avatar': 'Personnaliser l\'avatar',
      'save_changes': 'Enregistrer',
      'cancel': 'Annuler',
      'edit_settings': 'Modifier les paramètres',
      'settings_dialog_title': 'Modifier les paramètres',
      'settings_dialog_body': 'Voulez-vous modifier les paramètres de l\'application ? Cela vous ramènera à l\'assistant de configuration.',
      'settings_dialog_body': 'Voulez-vous modifier les paramètres de l\'application ? Cela vous ramènera à l\'assistant de configuration.',
      'lang_title': 'Langue',
      'theme_title': 'Thème',
      'library_name': 'Nom de la bibliothèque',
      'edit_library_name': 'Modifier le nom',
      'library_updated': 'Nom de la bibliothèque mis à jour',
      'error_updating_library': 'Erreur lors de la mise à jour',
      'reset_app': 'Réinitialiser l\'application',
      'reset_app_title': 'Réinitialiser l\'application',
      'reset_app_confirmation': 'Êtes-vous sûr de vouloir réinitialiser l\'application ? Cela effacera toutes les données locales et vous ramènera à l\'assistant de configuration.',
      'reset_confirm': 'Tout réinitialiser',
      'import_success': 'Livres importés avec succès !',
      'import_fail': 'Échec de l\'importation',
      'export_success': 'Sauvegarde prête',
      'export_fail': 'Échec de l\'exportation',
      'error': 'Erreur',
      'no_data': 'Aucune donnée',
      'borrow_requests_title': 'Demandes d\'emprunt',
      'tab_incoming': 'Reçus',
      'tab_outgoing': 'Envoyés',
      'tab_connections': 'Connexions',
      'no_incoming_requests': 'Aucune demande reçue',
      'no_outgoing_requests': 'Aucune demande envoyée',
      'no_pending_connections': 'Aucune demande de connexion',
      'incoming_connections': 'Connexions entrantes',
      'outgoing_connections': 'Connexions sortantes',
      'unknown_library': 'Bibliothèque inconnue',
      'unknown_book': 'Livre inconnu',
      'from': 'De',
      'to': 'À',
      'status_pending': 'EN ATTENTE',
      'status_accepted': 'ACCEPTÉ',
      'status_rejected': 'REJETÉ',
      'status_returned': 'RETOURNÉ',
      'btn_accept': 'Accepter',
      'btn_reject': 'Rejeter',
      'btn_mark_returned': 'Marquer comme retourné',
      'btn_cancel_request': 'Annuler la demande',
      'btn_remove': 'Supprimer',
      'dialog_delete_title': 'Supprimer la demande',
      'dialog_delete_body': 'Voulez-vous vraiment supprimer cette demande ?',
      'dialog_delete_confirm': 'Supprimer',
      'snack_error_fetching': 'Erreur lors de la récupération des demandes',
      'snack_error_updating': 'Erreur lors de la mise à jour du statut',
      'snack_connection_updated': 'Connexion mise à jour',
      'p2p_title': 'Connecter une bibliothèque',
      'tab_share_code': 'Partager le code',
      'tab_scan_code': 'Scanner le code',
      'qr_error': 'Impossible de générer le QR Code.',
      'retry': 'Réessayer',
      'scan_to_connect': 'Scanner pour se connecter',
      'share_code_instruction': 'Montrez ce code à un autre utilisateur pour qu\'il se connecte à votre bibliothèque.',
      'scan_instruction': 'Alignez le QR code dans le cadre',
      'connected_to': 'Connecté à',
      'connection_failed': 'Échec de la connexion',
      'network_libraries_title': 'Bibliothèques du réseau',
      'manual_connection_title': 'Debug : Connexion Manuelle',
      'library_url': 'URL de la bibliothèque',
      'connect': 'Se connecter',
      'added_from_network': 'Ajouté depuis le réseau',
      'added_to_contacts': 'Ajouté aux contacts',
      'added_to_borrowers': 'Ajouté aux emprunteurs',
      'error_adding': 'Erreur lors de l\'ajout',
      'status_waiting': 'En attente',
      'request_sent': 'Demande envoyée',
      'tooltip_cancel_request': 'Annuler la demande',
      'tooltip_sync': 'Synchroniser la bibliothèque',
      'sync_started': 'Synchronisation démarrée',
      'tooltip_add_contact': 'Ajouter aux contacts',
      'tooltip_remove_library': 'Supprimer la bibliothèque',
      'library_not_accepted': 'Cette bibliothèque n\'a pas encore accepté votre demande',
      'dialog_remove_library_title': 'Supprimer la bibliothèque',
      'dialog_remove_library_body': 'Voulez-vous vraiment supprimer cette bibliothèque de votre réseau ?',
      'library_removed': 'Bibliothèque supprimée avec succès',
      'error_removing': 'Erreur lors de la suppression de la bibliothèque',
      'total_books': 'Total Livres',
      'active_loans': 'Prêts actifs',
      'welcome_title': 'Bienvenue sur BiblioGenius !',
      'welcome_subtitle': 'Votre bibliothèque semble un peu vide. Commencez par ajouter votre premier livre ou faites une recherche en ligne.',
      'btn_add_manually': 'Ajouter manuellement',
      'btn_search_online': 'Rechercher en ligne',
      'quick_actions': 'Actions rapides',
      'action_add_book': 'Ajouter un livre',
      'action_checkout_book': 'Emprunter un livre',
      'action_search_remote': 'Recherche distante',
      'action_ask_library': 'Demander à la bibliothèque',
      'recent_books': 'Livres récents',
      'no_recent_books': 'Aucun livre récent',
      'reading_list': 'Liste de lecture',
      'no_reading_list': 'Aucun livre dans la liste de lecture',
      'view_insights': 'Voir les statistiques',
      'unknown_author': 'Auteur inconnu',
      'btn_details': 'Détails',
      'scan_isbn': 'Scanner un ISBN',
      'search_hint': 'Rechercher des livres...',
      'my_library_title': 'Ma Bibliothèque',
      'search_books': 'Rechercher des livres',
      'book_details_found': 'Détails du livre trouvés !',
      'book_updated': 'Livre mis à jour avec succès',
      'error_updating_book': 'Erreur lors de la mise à jour du livre',
      'delete_book_title': 'Supprimer le livre',
      'delete_book_confirm': 'Êtes-vous sûr de vouloir supprimer ce livre ?',
      'delete_book_btn': 'Supprimer le livre',
      'cancel': 'Annuler',
      'error_deleting_book': 'Erreur lors de la suppression du livre',
      'summary_label': 'Résumé',
      'no_summary': 'Aucun résumé disponible.',
      'borrowed_label': 'Emprunté',
      'lend_book_label': 'Prêter le livre',
      'no_copies_title': 'Aucune copie trouvée',
      'no_copies_confirm': 'Ce livre n\'a pas de copie. Créer une nouvelle copie pour le prêter ?',
      'create_lend_btn': 'Créer & Prêter',
      'failed_create_copy': 'Échec de la création de la copie.',
      'all_copies_lent': 'Toutes les copies sont actuellement prêtées.',
      'book_lent_to': 'Livre prêté à',
      'error_lending_book': 'Erreur lors du prêt du livre',
      'currently_reading': 'En cours de lecture',
      'read_status': 'Lu',
      'wishlist_status': 'Liste de souhaits',
      'to_read_status': 'À lire',
      'edit_book_title': 'Modifier le livre',
      'edit_book_details': 'Modifier les détails du livre',
      'title_label': 'Titre *',
      'enter_book_title': 'Entrer le titre du livre',
      'enter_title_error': 'Veuillez entrer un titre',
      'isbn_label': 'ISBN',
      'enter_isbn': 'Entrer l\'ISBN',
      'publisher_label': 'Éditeur',
      'publisher_hint': 'Nom de l\'éditeur',
      'year_label': 'Année',
      'year_hint': 'AAAA',
      'summary_hint': 'Bref résumé du livre',
      'status_label': 'Statut',
      'save_changes': 'Enregistrer les modifications',
      'saving_changes': 'Enregistrement...',
      'add_book_title': 'Ajouter un livre',
      'add_new_book': 'Ajouter un nouveau livre',
      'author_label': 'Auteur',
      'author_hint': 'Nom de l\'auteur',
      'enter_isbn_autofill': 'Entrer l\'ISBN pour remplir automatiquement',
      'lookup_isbn': 'Rechercher ISBN',
      'save_book': 'Enregistrer le livre',
      'saving': 'Enregistrement...',
      'error_saving_book': 'Erreur lors de l\'enregistrement du livre',
      'copies_title': 'Exemplaires de',
      'copy_number': 'Exemplaire n°',
      'no_copies': 'Aucune copie trouvée',
      'book_summary': 'Résumé',
      'book_deleted': 'Livre supprimé',
      'mark_as_finished': 'Marquer comme lu',
      'finished_on': 'Terminé le',
      'start_reading': 'Commencer la lecture',
      'started_on': 'Commencé le',
      'reading_status_read': 'Lu',
      'reading_status_reading': 'En cours',
      'reading_status_to_read': 'À lire',
      'tags': 'Tags',
      'add_tag_hint': 'Ajouter un tag...',
      'started_reading_label': 'Commencé le',
      'finished_reading_label': 'Terminé le',
      'select_date': 'Choisir une date',
      'status_updated': 'Statut mis à jour',
      'date_select_title': 'Sélectionner une date',
      'date_select_option_today': "Aujourd'hui",
      'date_select_option_pick': 'Choisir une date',
      'date_select_option_none': 'Pas de date',
      'filter_all': 'Tout',
      // App Drawer
      'nav_dashboard': 'Tableau de bord',
      'nav_my_library': 'Ma Bibliothèque',
      'nav_contacts': 'Contacts',
      'nav_p2p': 'Connexion',
      'nav_network': 'Réseau de bibliothèques',
      'nav_requests': 'Demandes d\'emprunt',
      'nav_profile': 'Mon Profil',
      // Contacts Screen
      'delete_contact_title': 'Supprimer le contact',
      'delete_contact_confirm': 'Êtes-vous sûr de vouloir supprimer ce contact ?',
      'delete_contact_btn': 'Supprimer',
      'contact_deleted': 'Contact supprimé avec succès',
      'error_deleting_contact': 'Erreur lors de la suppression du contact',
      'error_loading_contacts': 'Erreur lors du chargement des contacts',
      'filter_all_contacts': 'Tous les contacts',
      'filter_borrowers': 'Emprunteurs',
      'filter_libraries': 'Bibliothèques',
      // Loan Dialog
      'lend_book_title': 'Prêter le livre',
      'no_borrowers_found': 'Aucun emprunteur trouvé. Ajoutez d\'abord un contact.',
      'select_contact_lend': 'Sélectionnez un contact à qui prêter ce livre :',
      'lend_btn': 'Prêter',
      // Scan Screen
      'scan_isbn_title': 'Scanner un ISBN',
      'btn_enter_manually': 'Saisir manuellement',
      // External Search
      'external_search_title': 'Recherche de livre externe',
      'enter_search_term': 'Veuillez entrer au moins un terme de recherche',
      'failed_add_book': 'Échec de l\'ajout du livre',
      'search_open_library': 'Rechercher en ligne',
      // Search Peer
      'request_sent_to': 'Demande envoyée à',
      'connection_error': 'Erreur de connexion',
      'scan_qr_code': 'Ou scannez un QR Code',
      'already_connected': 'Déjà connecté',
      'add_peer_btn': 'Ajouter',
      'peer_search_hint': 'Ex: Bibliothèque de Thomas',
      // Setup Screen
      'choose_profile_type': 'Choisir le type de profil',
      'profile_usage_question': 'Comment allez-vous utiliser BiblioGenius ?',
      'customize_avatar': 'Personnaliser l\'avatar',
      'setup_failed': 'Échec de la configuration',
      'lang_en': 'Anglais',
      'lang_fr': 'Français',
      'lang_es': 'Espagnol',
      'lang_de': 'Allemand',
      'theme_default': 'Défaut (Coloré)',
      'theme_minimal': 'Minimal (Épuré)',
      // Login Screen
      'login_title': 'Connexion',
      'login_btn': 'Se connecter',
      'new_server_setup': 'Nouveau serveur ? Lancer la configuration',
      // Contact Details
      'contact_details_title': 'Détails du contact',
      'edit_feature_soon': 'Fonctionnalité d\'édition bientôt disponible',
      // Book List
      'menu_edit': 'Modifier',
      'menu_manage_copies': 'Gérer les copies',
      // Book Status
      'status_available': 'Disponible',
      'status_checked_out': 'Emprunté',
      'status_reference': 'Consultation sur place',
      'status_missing': 'Manquant/Perdu',
      'status_damaged': 'Endommagé/Réparation',
      'status_on_order': 'En commande',
      // Profiles
      'profile_librarian': 'Bibliothécaire',
      'profile_librarian_desc': 'Catalogage professionnel, gestion des prêts et organisation stricte.',
      'profile_individual': 'Lecteur Individuel',
      'profile_individual_desc': 'Suivez vos lectures, listes de souhaits et collection personnelle.',
      'profile_kid': 'Jeune Lecteur',
      'profile_kid_desc': 'Interface amusante, suivi simple et avatars sympas !',
      // Avatars
      'avatar_junior_reader': 'Jeune Lecteur',
      'avatar_bookworm': 'Rat de bibliothèque',
      'avatar_young_reader': 'Jeune Lectrice',
      'avatar_grandmother': 'Grand-mère',
      'avatar_head_librarian': 'Bibliothécaire en Chef',
      'avatar_professional_librarian': 'Bibliothécaire Pro',
      // Badges
      'badge_pro': 'Pro',
      'badge_bibliogenius': 'BiblioGenius',
      'badge_member': 'Membre',
      // Avatar Customizer
      'avatar_style': 'Style d\'avatar',
      'avatar_bg_color': 'Couleur de fond',
      'avatar_expression': 'Expression',
      'avatar_hair': 'Cheveux',
      'avatar_facial_hair': 'Barbe/Moustache',
      'avatar_skin_color': 'Couleur de peau',
      'avatar_hair_color': 'Couleur des cheveux',
      'avatar_accessories': 'Accessoires',
      'avatar_clothing': 'Vêtements',
      // Dashboard & Search
      'error_loading_dashboard': 'Erreur lors du chargement du tableau de bord',
      'error_saving_avatar': 'Erreur lors de l\'enregistrement de l\'avatar',
      'subject_label': 'Sujet',
      'unknown_title': 'Titre inconnu',
      'add_to_library_tooltip': 'Ajouter à la bibliothèque',
      'borrowers': 'Emprunteurs',
      'search_failed': 'La recherche a échoué',
      'added_to_library': 'ajouté à la bibliothèque',
      // Statistics
      'library_insights': 'Statistiques',
      'no_books_analyze': 'Aucun livre à analyser pour le moment !',
      'reading_habits': 'Habitudes de lecture',
      'top_authors': 'Auteurs les plus lus',
      'publication_timeline': 'Chronologie de publication',
      'stat_total_books': 'Total Livres',
      'stat_read': 'Lus',
      'stat_borrowed': 'Empruntés',
      'stat_unique_authors': 'Auteurs uniques',
      'stat_completion': 'Complétion',
      'stat_oldest_book': 'Livre le plus ancien',
      'stat_avg_year': 'Année moy.',
      'stat_books_per_author': 'Livres/Auteur',
      'wizard_menu_title': 'Menu Principal',
      'wizard_menu_desc': 'Accédez à votre bibliothèque, vos contacts et vos paramètres ici.',
      'wizard_add_title': 'Ajouter des livres',
      'wizard_add_desc': 'Scannez un code-barres ou cherchez en ligne pour ajouter des livres.',
      'wizard_search_title': 'Rechercher',
      'wizard_search_desc': 'Trouvez des livres dans votre bibliothèque ou celles de vos amis.',
      'wizard_stats_title': 'Statistiques rapides',
      'wizard_stats_desc': 'Voyez combien de livres vous avez et qui les a empruntés.',
      'wizard_skip': 'Passer',
      
      //  Onboarding Tour
      'onboarding_skip': 'Passer',
      'onboarding_next': 'Suivant',
      'onboarding_finish': 'Commencer',
      'onboarding_tap_continue': 'Appuyez n\'importe où pour continuer',
      'menu_tutorial': 'Tutoriel',
      
      'onboarding_welcome_title': 'Bienvenue dans BiblioGenius !',
      'onboarding_welcome_desc': 'Votre gestionnaire de bibliothèque personnelle. Organisez vos livres, connectez-vous avec vos amis et suivez votre parcours de lecture.',
      
      'onboarding_books_title': 'Gérez Votre Bibliothèque',
      'onboarding_books_desc': 'Ajoutez des livres en scannant les codes-barres, en cherchant dans les bases de données en ligne, ou en entrant les détails manuellement.',
      
      'onboarding_p2p_title': 'Connectez & Partagez',
      'onboarding_p2p_desc': 'Connectez-vous avec d\'autres utilisateurs BiblioGenius pour partager vos bibliothèques. Voyez ce que vos amis lisent et découvrez de nouveaux livres.',
      
      'onboarding_contacts_title': 'Suivez les Emprunteurs',
      'onboarding_contacts_desc': 'Gérez vos contacts et gardez une trace de qui a emprunté quoi. Ne perdez plus jamais vos livres.',
      
      'onboarding_stats_title': 'Surveillez Votre Collection',
      'onboarding_stats_desc': 'Consultez les statistiques de votre bibliothèque, suivez vos habitudes de lecture et regardez votre collection grandir.',
      'no_pub_year_data': 'Aucune donnée de publication.',
      'nav_p2p_connect': 'Connexion',
      'nav_help': 'Aide',
      'help_title': 'Aide & Support',
      'help_topic_add_book': 'Comment ajouter un livre ?',
      'help_desc_add_book': 'Allez dans "Ma Bibliothèque" et appuyez sur "+". Vous pouvez scanner un code-barres ou chercher par titre/ISBN.',
      'help_topic_lend': 'Comment prêter un livre ?',
      'help_desc_lend': 'Trouvez le livre, appuyez sur "Gérer les copies", puis "Prêter". Choisissez un contact.',
      'help_topic_connect': 'Comment se connecter avec des amis ?',
      'help_desc_connect': 'Allez dans "Connecter une bibliothèque" pour partager votre QR code ou scanner celui d\'un ami.',
      'add_contact_title': 'Ajouter un contact',
      'contact_type_label': 'Type',
      'role_borrower': 'Emprunteur',
      'role_library': 'Bibliothèque',
      'contact_name_label': 'Nom *',
      'contact_name_required': 'Veuillez entrer un nom',
      'contact_email_label': 'Email',
      'contact_email_invalid': 'Veuillez entrer un email valide',
      'contact_phone_label': 'Téléphone',
      'contact_address_label': 'Adresse',
      'contact_notes_label': 'Notes',
      'save_contact': 'Enregistrer le contact',
      'contact_created': 'Contact créé avec succès',
      'error_creating_contact': 'Erreur lors de la création du contact',
      'friends_libraries_title': 'Bibliothèques d\'amis',
      'network_search_title': 'Emprunter un livre',
      'network_search_hint': 'Rechercher dans votre réseau...',
      'network_search_no_results': 'Aucun livre trouvé dans votre réseau',
      'network_search_prompt': 'Recherchez des livres disponibles dans les bibliothèques de vos amis',
      'request_book_btn': 'Demander',
    },
    'es': {
      'app_title': 'BiblioGenius',
      'app_subtitle': 'Gestor de biblioteca inteligente',
      'dashboard': 'Tablero',
      'home': 'Inicio',
      'library': 'Biblioteca',
      'contacts': 'Contactos',
      'p2p': 'P2P',
      'network': 'Red',
      'requests': 'Solicitudes',
      'books': 'Libros',
      'profile': 'Mi Perfil',
      'librarian': 'Bibliotecario',
      'individual': 'Individual',
      'professional': 'Profesional',
      'loans': 'Préstamos',
      'edits': 'Ediciones',
      'next_level_progress': 'Progreso',
      'to_next_level': 'para el siguiente nivel',
      'profile_settings': 'Configuración del perfil',
      'profile_type': 'Tipo de perfil',
      'show_borrowed_books': 'Mostrar libros prestados',
      'show_borrowed_subtitle': 'Incluir libros prestados en la vista de biblioteca',
      'data_management': 'Gestión de datos',
      'export_backup': 'Exportar copia de seguridad',
      'import_csv': 'Importar de Goodreads/LibraryThing',
      'app_settings': 'Configuración de la aplicación',
      'logout': 'Cerrar sesión',
      'customize_avatar': 'Personalizar avatar',
      'save_changes': 'Guardar cambios',
      'cancel': 'Cancelar',
      'edit_settings': 'Editar configuración',
      'settings_dialog_title': 'Editar configuración',
      'settings_dialog_body': '¿Quieres modificar la configuración de la aplicación?',
      'settings_dialog_body': '¿Quieres modificar la configuración de la aplicación?',
      'lang_title': 'Idioma',
      'theme_title': 'Tema',
      'library_name': 'Nombre de la biblioteca',
      'edit_library_name': 'Editar nombre',
      'library_updated': 'Nombre de la biblioteca actualizado',
      'error_updating_library': 'Error al actualizar nombre',
      'reset_app': 'Reiniciar aplicación',
      'reset_app_title': 'Reiniciar aplicación',
      'reset_app_confirmation': '¿Estás seguro de que quieres reiniciar la aplicación? Esto borrará todos los datos locales y te devolverá al asistente de configuración.',
      'reset_confirm': 'Reiniciar todo',
      'import_success': '¡Libros importados con éxito!',
      'import_fail': 'Fallo en la importación',
      'export_success': 'Copia de seguridad lista',
      'export_fail': 'Fallo en la exportación',
      'error': 'Error',
      'no_data': 'Sin datos',
      'borrow_requests_title': 'Solicitudes de préstamo',
      'tab_incoming': 'Recibidos',
      'tab_outgoing': 'Enviados',
      'tab_connections': 'Conexiones',
      'no_incoming_requests': 'No hay solicitudes recibidas',
      'no_outgoing_requests': 'No hay solicitudes enviadas',
      'no_pending_connections': 'No hay solicitudes de conexión pendientes',
      'incoming_connections': 'Conexiones entrantes',
      'outgoing_connections': 'Conexiones salientes',
      'unknown_library': 'Biblioteca desconocida',
      'unknown_book': 'Libro desconocido',
      'from': 'De',
      'to': 'A',
      'status_pending': 'PENDIENTE',
      'status_accepted': 'ACEPTADO',
      'status_rejected': 'RECHAZADO',
      'status_returned': 'DEVUELTO',
      'btn_accept': 'Aceptar',
      'btn_reject': 'Rechazar',
      'btn_mark_returned': 'Marcar como devuelto',
      'btn_cancel_request': 'Cancelar solicitud',
      'btn_remove': 'Eliminar',
      'dialog_delete_title': 'Eliminar solicitud',
      'dialog_delete_body': '¿Estás seguro de que quieres eliminar esta solicitud?',
      'dialog_delete_confirm': 'Eliminar',
      'snack_error_fetching': 'Error al obtener solicitudes',
      'snack_error_updating': 'Error al actualizar estado',
      'snack_connection_updated': 'Conexión actualizada',
      'p2p_title': 'Conectar biblioteca',
      'tab_share_code': 'Compartir código',
      'tab_scan_code': 'Escanear código',
      'qr_error': 'No se pudo generar el código QR.',
      'retry': 'Reintentar',
      'scan_to_connect': 'Escanear para conectar',
      'share_code_instruction': 'Muestra este código a otro usuario para que se conecte a tu biblioteca.',
      'scan_instruction': 'Alinea el código QR dentro del marco',
      'connected_to': 'Conectado a',
      'connection_failed': 'Error al conectar',
      'network_libraries_title': 'Bibliotecas de la red',
      'manual_connection_title': 'Depuración: Conexión Manual',
      'library_url': 'URL de la biblioteca',
      'connect': 'Conectar',
      'added_from_network': 'Añadido desde la red',
      'added_to_contacts': 'Añadido a contactos',
      'added_to_borrowers': 'Añadido a prestatarios',
      'error_adding': 'Error al añadir',
      'status_waiting': 'En espera',
      'request_sent': 'Solicitud enviada',
      'tooltip_cancel_request': 'Cancelar solicitud',
      'tooltip_sync': 'Sincronizar biblioteca',
      'sync_started': 'Sincronización iniciada',
      'tooltip_add_contact': 'Añadir a contactos',
      'tooltip_remove_library': 'Eliminar biblioteca',
      'library_not_accepted': 'Esta biblioteca aún no ha aceptado tu solicitud',
      'dialog_remove_library_title': 'Eliminar biblioteca',
      'dialog_remove_library_body': '¿Estás seguro de que quieres eliminar esta biblioteca de tu red?',
      'library_removed': 'Biblioteca eliminada con éxito',
      'error_removing': 'Error al eliminar biblioteca',
      'total_books': 'Total Libros',
      'active_loans': 'Préstamos activos',
      'welcome_title': '¡Bienvenido a BiblioGenius!',
      'welcome_subtitle': 'Tu biblioteca parece un poco vacía. Empieza añadiendo tu primer libro o buscando en línea.',
      'btn_add_manually': 'Añadir manualmente',
      'btn_search_online': 'Buscar en línea',
      'quick_actions': 'Acciones rápidas',
      'action_add_book': 'Añadir libro',
      'action_checkout_book': 'Prestar libro',
      'action_search_remote': 'Búsqueda remota',
      'action_ask_library': 'Preguntar a la biblioteca',
      'recent_books': 'Libros recientes',
      'no_recent_books': 'No hay libros recientes',
      'reading_list': 'Lista de lectura',
      'no_reading_list': 'No hay libros en la lista de lectura',
      'view_insights': 'Ver estadísticas',
      'unknown_author': 'Autor desconocido',
      'btn_details': 'Detalles',
      'scan_isbn': 'Escanear ISBN',
      'search_hint': 'Buscar libros...',
      'my_library_title': 'Mi Biblioteca',
      'search_books': 'Buscar libros',
      'book_details_found': '¡Detalles del libro encontrados!',
      'book_updated': 'Libro actualizado con éxito',
      'error_updating_book': 'Error al actualizar el libro',
      'delete_book_title': 'Eliminar libro',
      'delete_book_confirm': '¿Estás seguro de que quieres eliminar este libro?',
      'delete_book_btn': 'Eliminar libro',
      'cancel': 'Cancelar',
      'error_deleting_book': 'Error al eliminar el libro',
      'summary_label': 'Resumen',
      'no_summary': 'No hay resumen disponible.',
      'borrowed_label': 'Prestado',
      'lend_book_label': 'Prestar libro',
      'no_copies_title': 'No se encontraron copias',
      'no_copies_confirm': 'Este libro no tiene copias. ¿Crear una nueva copia para prestar?',
      'create_lend_btn': 'Crear y Prestar',
      'failed_create_copy': 'Error al crear copia.',
      'all_copies_lent': 'Todas las copias están prestadas actualmente.',
      'book_lent_to': 'Libro prestado a',
      'error_lending_book': 'Error al prestar el libro',
      'currently_reading': 'Leyendo actualmente',
      'read_status': 'Leído',
      'wishlist_status': 'Lista de deseos',
      'to_read_status': 'Por leer',
      'filter_all': 'Todos',
      'tags': 'Etiquetas',
      'add_tag_hint': 'Añadir etiqueta...',
      'edit_book_title': 'Editar libro',
      'edit_book_details': 'Editar detalles del libro',
      'title_label': 'Título *',
      'enter_book_title': 'Introducir título del libro',
      'enter_title_error': 'Por favor, introduce un título',
      'isbn_label': 'ISBN',
      'enter_isbn': 'Introducir ISBN',
      'publisher_label': 'Editor',
      'publisher_hint': 'Nombre del editor',
      'year_label': 'Año',
      'year_hint': 'AAAA',
      'summary_hint': 'Breve resumen del libro',
      'status_label': 'Estado',
      'save_changes': 'Guardar cambios',
      'saving_changes': 'Guardando cambios...',
      'add_book_title': 'Añadir libro',
      'add_new_book': 'Añadir un nuevo libro',
      'author_label': 'Autor',
      'author_hint': 'Nombre del autor',
      'enter_isbn_autofill': 'Introducir ISBN para autocompletar',
      'lookup_isbn': 'Buscar ISBN',
      'save_book': 'Guardar libro',
      'saving': 'Guardando...',
      'error_saving_book': 'Error al guardar el libro',
      'copies_title': 'Copias de',
      'copy_number': 'Copia #',
      'no_copies': 'No se encontraron copias',
      'book_summary': 'Resumen',
      'book_deleted': 'Libro eliminado',
      // App Drawer
      'nav_dashboard': 'Panel de control',
      'nav_my_library': 'Mi Biblioteca',
      'nav_contacts': 'Contactos',
      'nav_p2p': 'Conexión',
      'nav_network': 'Red de bibliotecas',
      'nav_p2p_connect': 'Conexión',
      'nav_help': 'Ayuda',
      'help_title': 'Ayuda y Soporte',
      'help_topic_add_book': '¿Cómo añadir un libro?',
      'help_desc_add_book': 'Ve a "Mi Biblioteca" y toca el botón "+". Puedes escanear un código de barras o buscar por título/ISBN.',
      'help_topic_lend': '¿Cómo prestar un libro?',
      'help_desc_lend': 'Encuentra el libro, toca "Gestionar copias", luego "Prestar". Elige un contacto.',
      'help_topic_connect': '¿Cómo conectar con amigos?',
      'help_desc_connect': 'Ve a "Conectar biblioteca" para compartir tu código QR o escanear el de un amigo.',
      'add_contact_title': 'Añadir contacto',
      'contact_type_label': 'Tipo',
      'role_borrower': 'Prestatario',
      'role_library': 'Biblioteca',
      'contact_name_label': 'Nombre *',
      'contact_name_required': 'Por favor ingrese un nombre',
      'contact_email_label': 'Email',
      'contact_email_invalid': 'Por favor ingrese un email válido',
      'contact_phone_label': 'Teléfono',
      'contact_address_label': 'Dirección',
      'contact_notes_label': 'Notas',
      'save_contact': 'Guardar contacto',
      'contact_created': 'Contacto creado con éxito',
      'error_creating_contact': 'Error al crear contacto',
      'friends_libraries_title': 'Bibliotecas de amigos',
      'network_search_title': 'Tomar prestado un libro',
      'network_search_hint': 'Buscar en tu red...',
      'network_search_no_results': 'No se encontraron libros en tu red',
      'network_search_prompt': 'Busca libros disponibles en las bibliotecas de tus amigos',
      'request_book_btn': 'Solicitar',
      'nav_requests': 'Solicitudes de préstamo',
      'nav_profile': 'Mi Perfil',
      // Contacts Screen
      'delete_contact_title': 'Eliminar contacto',
      'delete_contact_confirm': '¿Estás seguro de que quieres eliminar este contacto?',
      'delete_contact_btn': 'Eliminar',
      'contact_deleted': 'Contacto eliminado con éxito',
      'error_deleting_contact': 'Error al eliminar contacto',
      'error_loading_contacts': 'Error al cargar contactos',
      'filter_all_contacts': 'Todos los contactos',
      'filter_borrowers': 'Prestatarios',
      'filter_libraries': 'Bibliotecas',
      // Loan Dialog
      'lend_book_title': 'Prestar libro',
      'no_borrowers_found': 'No se encontraron prestatarios. Añade un contacto primero.',
      'select_contact_lend': 'Selecciona un contacto para prestar este libro:',
      'lend_btn': 'Prestar',
      'wizard_menu_title': 'Menú Principal',
      'wizard_menu_desc': 'Accede a tu biblioteca, contactos y configuración aquí.',
      'wizard_add_title': 'Añadir libros',
      'wizard_add_desc': 'Escanea un código de barras o busca en línea para añadir libros.',
      'wizard_search_title': 'Buscar',
      'wizard_search_desc': 'Encuentra libros en tu biblioteca o en las de tus amigos.',
      'wizard_stats_title': 'Estadísticas rápidas',
      'wizard_stats_desc': 'Mira cuántos libros tienes y quién los ha tomado prestados.',
      'wizard_skip': 'Saltar',
      
      // Onboarding Tour
      'onboarding_skip': 'Saltar',
      'onboarding_next': 'Siguiente',
      'onboarding_finish': 'Comenzar',
      'onboarding_tap_continue': 'Toque en cualquier lugar para continuar',
      'menu_tutorial': 'Tutorial',
      
      'onboarding_welcome_title': '¡Bienvenido a BiblioGenius!',
      'onboarding_welcome_desc': 'Tu gestor de biblioteca personal. Organiza tus libros, conéctate con amigos y sigue tu trayectoria de lectura.',
      
      'onboarding_books_title': 'Gestiona Tu Biblioteca',
      'onboarding_books_desc': 'Añade libros escaneando códigos de barras, buscando en bases de datos en línea, o introduciendo detalles manualmente.',
      
      'onboarding_p2p_title': 'Conecta y Comparte',
      'onboarding_p2p_desc': 'Conéctate con otros usuarios de BiblioGenius para compartir bibliotecas. Ve lo que leen tus amigos y descubre nuevos libros.',
      
      'onboarding_contacts_title': 'Rastrea Prestatarios',
      'onboarding_contacts_desc': 'Gestiona tus contactos y lleva un registro de quién tomó prestado qué. Nunca pierdas el rastro de tus libros.',
      
      'onboarding_stats_title': 'Monitorea Tu Colección',
      'onboarding_stats_desc': 'Ve estadísticas sobre tu biblioteca, sigue hábitos de lectura y observa crecer tu colección.',
      // Scan Screen
      'scan_isbn_title': 'Escanear ISBN',
      // External Search
      'external_search_title': 'Búsqueda externa de libros',
      'enter_search_term': 'Por favor, introduce al menos un término de búsqueda',
      'failed_add_book': 'Error al añadir libro',
      'search_open_library': 'Buscar en línea',
      // Search Peer
      'request_sent_to': 'Solicitud enviada a',
      'connection_error': 'Error de conexión',
      'scan_qr_code': 'O escanear un código QR',
      'already_connected': 'Ya conectado',
      'add_peer_btn': 'Añadir',
      'peer_search_hint': 'Ej: Biblioteca de Thomas',
      // Setup Screen
      'choose_profile_type': 'Elegir tipo de perfil',
      'profile_usage_question': '¿Cómo usarás BiblioGenius?',
      'customize_avatar': 'Personalizar avatar',
      'setup_failed': 'Configuración fallida',
      'lang_en': 'Inglés',
      'lang_fr': 'Francés',
      'lang_es': 'Español',
      'lang_de': 'Alemán',
      'theme_default': 'Por defecto (Colorido)',
      'theme_minimal': 'Minimalista (Limpio)',
      // Login Screen
      'login_title': 'Iniciar sesión',
      'login_btn': 'Iniciar sesión',
      'new_server_setup': '¿Nuevo servidor? Ejecutar configuración',
      // Contact Details
      'contact_details_title': 'Detalles del contacto',
      'edit_feature_soon': 'Función de edición próximamente',
      // Book List
      'menu_edit': 'Editar',
      'menu_manage_copies': 'Gestionar copias',
      // Book Status
      'status_available': 'Disponible',
      'status_checked_out': 'Prestado',
      'status_reference': 'Solo referencia',
      'status_missing': 'Faltante/Perdido',
      'status_damaged': 'Dañado/Reparación',
      'status_on_order': 'Pedido',
      // Profiles
      'profile_librarian': 'Bibliotecario',
      'profile_librarian_desc': 'Catalogación profesional, gestión de préstamos y organización estricta.',
      'profile_individual': 'Lector Individual',
      'profile_individual_desc': 'Sigue tus lecturas, listas de deseos y colección personal.',
      'profile_kid': 'Lector Junior',
      'profile_kid_desc': '¡Interfaz divertida, seguimiento simple y avatares geniales!',
      // Avatars
      'avatar_junior_reader': 'Lector Junior',
      'avatar_bookworm': 'Ratón de biblioteca',
      'avatar_young_reader': 'Joven Lectora',
      'avatar_grandmother': 'Abuela',
      'avatar_head_librarian': 'Bibliotecario Jefe',
      'avatar_professional_librarian': 'Bibliotecario Profesional',
      // Badges
      'badge_pro': 'Pro',
      'badge_bibliogenius': 'BiblioGenius',
      'badge_member': 'Miembro',
      // Avatar Customizer
      'avatar_style': 'Estilo de avatar',
      'avatar_bg_color': 'Color de fondo',
      'avatar_expression': 'Expresión',
      'avatar_hair': 'Cabello',
      'avatar_facial_hair': 'Vello facial',
      'avatar_skin_color': 'Color de piel',
      'avatar_hair_color': 'Color de cabello',
      'avatar_accessories': 'Accesorios',
      'avatar_clothing': 'Ropa',
      // Dashboard & Search
      'error_loading_dashboard': 'Error al cargar el panel',
      'error_saving_avatar': 'Error al guardar el avatar',
      'subject_label': 'Asunto',
      'unknown_title': 'Título desconocido',
      'add_to_library_tooltip': 'Añadir a la biblioteca',
      'borrowers': 'Prestatarios',
      'search_failed': 'Búsqueda fallida',
      'added_to_library': 'añadido a la biblioteca',
      // Statistics
      'library_insights': 'Estadísticas',
      'no_books_analyze': '¡No hay libros para analizar todavía!',
      'reading_habits': 'Hábitos de lectura',
      'top_authors': 'Autores principales',
      'publication_timeline': 'Cronología de publicación',
      'stat_total_books': 'Total Libros',
      'stat_read': 'Leídos',
      'stat_borrowed': 'Prestados',
      'stat_unique_authors': 'Autores únicos',
      'stat_completion': 'Completado',
      'stat_oldest_book': 'Libro más antiguo',
      'stat_avg_year': 'Año prom.',
      'stat_books_per_author': 'Libros/Autor',
      'no_pub_year_data': 'Sin datos de año de publicación.',
    },
    'de': {
      'app_title': 'BiblioGenius',
      'app_subtitle': 'Intelligenter Bibliotheksmanager',
      'dashboard': 'Dashboard',
      'home': 'Startseite',
      'library': 'Bibliothek',
      'contacts': 'Kontakte',
      'p2p': 'P2P',
      'network': 'Netzwerk',
      'requests': 'Anfragen',
      'books': 'Bücher',
      'profile': 'Mein Profil',
      'librarian': 'Bibliothekar',
      'individual': 'Einzelperson',
      'professional': 'Professionell',
      'loans': 'Ausleihen',
      'edits': 'Bearbeitungen',
      'next_level_progress': 'Fortschritt',
      'to_next_level': 'zum nächsten Level',
      'profile_settings': 'Profileinstellungen',
      'profile_type': 'Profiltyp',
      'show_borrowed_books': 'Geliehene Bücher anzeigen',
      'show_borrowed_subtitle': 'Geliehene Bücher in der Bibliothek anzeigen',
      'data_management': 'Datenverwaltung',
      'export_backup': 'Backup exportieren',
      'import_csv': 'Von Goodreads/LibraryThing importieren',
      'app_settings': 'App-Einstellungen',
      'save_changes': 'Speichern',
      'cancel': 'Abbrechen',
      'edit_settings': 'Einstellungen bearbeiten',
      'settings_dialog_title': 'Einstellungen bearbeiten',
      'settings_dialog_body': 'Möchten Sie Ihre App-Einstellungen ändern?',
      'lang_title': 'Sprache',
      'theme_title': 'Thema',
      'import_success': 'Bücher erfolgreich importiert!',
      'import_fail': 'Import fehlgeschlagen',
      'export_success': 'Backup bereit',
      'export_fail': 'Export fehlgeschlagen',
      'error': 'Fehler',
      'no_data': 'Keine Daten',
      'borrow_requests_title': 'Ausleihanfragen',
      'tab_incoming': 'Eingehend',
      'tab_outgoing': 'Ausgehend',
      'tab_connections': 'Verbindungen',
      'no_incoming_requests': 'Keine eingehenden Anfragen',
      'no_outgoing_requests': 'Keine ausgehenden Anfragen',
      'no_pending_connections': 'Keine ausstehenden Verbindungsanfragen',
      'unknown_library': 'Unbekannte Bibliothek',
      'unknown_book': 'Unbekanntes Buch',
      'from': 'Von',
      'to': 'An',
      'status_pending': 'AUSSTEHEND',
      'status_accepted': 'AKZEPTIERT',
      'status_rejected': 'ABGELEHNT',
      'status_returned': 'ZURÜCKGEGEBEN',
      'btn_accept': 'Akzeptieren',
      'btn_reject': 'Ablehnen',
      'btn_mark_returned': 'Als zurückgegeben markieren',
      'btn_cancel_request': 'Anfrage abbrechen',
      'btn_remove': 'Entfernen',
      'dialog_delete_title': 'Anfrage löschen',
      'dialog_delete_body': 'Möchten Sie diese Anfrage wirklich löschen?',
      'dialog_delete_confirm': 'Löschen',
      'snack_error_fetching': 'Fehler beim Abrufen der Anfragen',
      'snack_error_updating': 'Fehler beim Aktualisieren des Status',
      'snack_connection_updated': 'Verbindung aktualisiert',
      'p2p_title': 'Bibliothek verbinden',
      'tab_share_code': 'Code teilen',
      'tab_scan_code': 'Code scannen',
      'qr_error': 'QR-Code konnte nicht generiert werden.',
      'retry': 'Wiederholen',
      'scan_to_connect': 'Scannen zum Verbinden',
      'share_code_instruction': 'Zeigen Sie diesen Code einem anderen Benutzer, damit er sich mit Ihrer Bibliothek verbinden kann.',
      'scan_instruction': 'Richten Sie den QR-Code im Rahmen aus',
      'connected_to': 'Verbunden mit',
      'connection_failed': 'Verbindung fehlgeschlagen',
      'network_libraries_title': 'Netzwerkbibliotheken',
      'manual_connection_title': 'Debug: Manuelle Verbindung',
      'library_url': 'Bibliotheks-URL',
      'connect': 'Verbinden',
      'added_from_network': 'Aus dem Netzwerk hinzugefügt',
      'added_to_contacts': 'Zu Kontakten hinzugefügt',
      'added_to_borrowers': 'Zu Ausleihern hinzugefügt',
      'error_adding': 'Fehler beim Hinzufügen',
      'status_waiting': 'Warten',
      'request_sent': 'Anfrage gesendet',
      'tooltip_cancel_request': 'Anfrage abbrechen',
      'tooltip_sync': 'Bibliothek synchronisieren',
      'sync_started': 'Synchronisierung gestartet',
      'tooltip_add_contact': 'Zu Kontakten hinzufügen',
      'tooltip_remove_library': 'Bibliothek entfernen',
      'library_not_accepted': 'Diese Bibliothek hat Ihre Anfrage noch nicht akzeptiert',
      'dialog_remove_library_title': 'Bibliothek entfernen',
      'dialog_remove_library_body': 'Möchten Sie diese Bibliothek wirklich aus Ihrem Netzwerk entfernen?',
      'library_removed': 'Bibliothek erfolgreich entfernt',
      'error_removing': 'Fehler beim Entfernen der Bibliothek',
      'total_books': 'Gesamt Bücher',
      'active_loans': 'Aktive Ausleihen',
      'welcome_title': 'Willkommen bei BiblioGenius!',
      'welcome_subtitle': 'Ihre Bibliothek sieht etwas leer aus. Beginnen Sie mit dem Hinzufügen Ihres ersten Buches oder suchen Sie online.',
      'btn_add_manually': 'Manuell hinzufügen',
      'btn_search_online': 'Online suchen',
      'quick_actions': 'Schnellaktionen',
      'action_add_book': 'Buch hinzufügen',
      'action_checkout_book': 'Buch ausleihen',
      'action_search_remote': 'Fernsuche',
      'action_ask_library': 'Bibliothek fragen',
      'recent_books': 'Neueste Bücher',
      'no_recent_books': 'Keine neuesten Bücher',
      'reading_list': 'Leseliste',
      'no_reading_list': 'Keine Bücher in der Leseliste',
      'view_insights': 'Statistiken anzeigen',
      'unknown_author': 'Unbekannter Autor',
      'btn_details': 'Details',
      'my_library_title': 'Meine Bibliothek',
      'search_books': 'Bücher suchen',
      'scan_isbn': 'ISBN scannen',
      // Profiles
      'profile_librarian': 'Bibliothekar',
      'profile_librarian_desc': 'Professionelle Katalogisierung, Ausleihmanagement und strikte Organisation.',
      'profile_individual': 'Einzelner Leser',
      'profile_individual_desc': 'Verfolgen Sie Ihre Lektüre, Wunschlisten und persönliche Sammlung.',
      'profile_kid': 'Junger Leser',
      'profile_kid_desc': 'Lustige Oberfläche, einfaches Tracking und coole Avatare!',
      // Avatars
      'avatar_junior_reader': 'Junger Leser',
      'avatar_bookworm': 'Bücherwurm',
      'avatar_young_reader': 'Junge Leserin',
      'avatar_grandmother': 'Großmutter',
      'avatar_head_librarian': 'Chefbibliothekar',
      'avatar_professional_librarian': 'Professioneller Bibliothekar',
      // Badges
      'badge_pro': 'Pro',
      'badge_bibliogenius': 'BiblioGenius',
      'badge_member': 'Mitglied',
      // Avatar Customizer
      'avatar_style': 'Avatar-Stil',
      'avatar_bg_color': 'Hintergrundfarbe',
      'avatar_expression': 'Ausdruck',
      'avatar_hair': 'Haare',
      'avatar_facial_hair': 'Gesichtsbehaarung',
      'avatar_skin_color': 'Hautfarbe',
      'avatar_hair_color': 'Haarfarbe',
      'avatar_accessories': 'Accessoires',
      'avatar_clothing': 'Kleidung',
      // Dashboard & Search
      'error_loading_dashboard': 'Fehler beim Laden des Dashboards',
      'error_saving_avatar': 'Fehler beim Speichern des Avatars',
      'subject_label': 'Thema',
      'unknown_title': 'Unbekannter Titel',
      'add_to_library_tooltip': 'Zur Bibliothek hinzufügen',
      'borrowers': 'Ausleiher',
      'search_failed': 'Suche fehlgeschlagen',
      'added_to_library': 'zur Bibliothek hinzugefügt',
      // Statistics
      'library_insights': 'Statistiken',
      'no_books_analyze': 'Noch keine Bücher zu analysieren!',
      'reading_habits': 'Lesegewohnheiten',
      'top_authors': 'Top-Autoren',
      'publication_timeline': 'Veröffentlichungszeitplan',
      'stat_total_books': 'Gesamtbücher',
      'stat_read': 'Gelesen',
      'stat_borrowed': 'Ausgeliehen',
      'stat_unique_authors': 'Einzigartige Autoren',
      'stat_completion': 'Abschluss',
      'stat_oldest_book': 'Ältestes Buch',
      'stat_avg_year': 'Durchschn. Jahr',
      'stat_books_per_author': 'Bücher/Autor',
      'no_pub_year_data': 'Keine Daten zum Veröffentlichungsjahr.',
      'search_hint': 'Bücher suchen...',
      'book_details_found': 'Buchdetails gefunden!',
      'book_updated': 'Buch erfolgreich aktualisiert',
      'error_updating_book': 'Fehler beim Aktualisieren des Buches',
      'delete_book_title': 'Buch löschen',
      'delete_book_confirm': 'Sind Sie sicher, dass Sie dieses Buch löschen möchten?',
      'delete_book_btn': 'Buch löschen',
      'cancel': 'Abbrechen',
      'error_deleting_book': 'Fehler beim Löschen des Buches',
      'summary_label': 'Zusammenfassung',
      'no_summary': 'Keine Zusammenfassung verfügbar.',
      'borrowed_label': 'Ausgeliehen',
      'lend_book_label': 'Buch ausleihen',
      'no_copies_title': 'Keine Exemplare gefunden',
      'no_copies_confirm': 'Dieses Buch hat keine Exemplare. Neues Exemplar erstellen zum Ausleihen?',
      'create_lend_btn': 'Erstellen & Ausleihen',
      'failed_create_copy': 'Fehler beim Erstellen des Exemplars.',
      'all_copies_lent': 'Alle Exemplare sind derzeit ausgeliehen.',
      'book_lent_to': 'Buch ausgeliehen an',
      'error_lending_book': 'Fehler beim Ausleihen des Buches',
      'currently_reading': 'Lese gerade',
      'read_status': 'Gelesen',
      'wishlist_status': 'Wunschliste',
      'to_read_status': 'Zu lesen',
      'filter_all': 'Tout',
      'tags': 'Tags',
      'add_tag_hint': 'Tag hinzufügen...',
      'edit_book_title': 'Buch bearbeiten',
      'edit_book_details': 'Buchdetails bearbeiten',
      'title_label': 'Titel *',
      'enter_book_title': 'Buchtitel eingeben',
      'isbn_label': 'ISBN',
      'enter_isbn': 'ISBN eingeben',
      'publisher_label': 'Verlag',
      'publisher_hint': 'Verlagsname',
      'year_label': 'Jahr',
      'year_hint': 'JJJJ',
      'summary_hint': 'Kurze Zusammenfassung des Buches',
      'status_label': 'Status',
      'saving_changes': 'Speichere Änderungen...',
      'add_book_title': 'Buch hinzufügen',
      'add_new_book': 'Neues Buch hinzufügen',
      'author_label': 'Autor',
      'author_hint': 'Autorenname',
      'enter_isbn_autofill': 'ISBN eingeben zum Ausfüllen',
      'lookup_isbn': 'ISBN nachschlagen',
      'save_book': 'Buch speichern',
      'saving': 'Speichern...',
      'error_saving_book': 'Fehler beim Speichern des Buches',
      'copies_title': 'Exemplare von',
      'copy_number': 'Exemplar Nr. ',
      'no_copies': 'Keine Exemplare gefunden',
      'book_summary': 'Zusammenfassung',
      'book_deleted': 'Buch gelöscht',
      // App Drawer
      'nav_dashboard': 'Dashboard',
      'nav_my_library': 'Meine Bibliothek',
      'nav_contacts': 'Kontakte',
      'nav_p2p': 'Verbindung',
      'nav_network': 'Bibliotheksnetzwerk',
      'nav_requests': 'Ausleihanfragen',
      'nav_profile': 'Mein Profil',
      // Contacts Screen
      'delete_contact_title': 'Kontakt löschen',
      'delete_contact_confirm': 'Sind Sie sicher, dass Sie diesen Kontakt löschen möchten?',
      'delete_contact_btn': 'Löschen',
      'contact_deleted': 'Kontakt erfolgreich gelöscht',
      'error_deleting_contact': 'Fehler beim Löschen des Kontakts',
      'error_loading_contacts': 'Fehler beim Laden der Kontakte',
      'filter_all_contacts': 'Alle Kontakte',
      'filter_borrowers': 'Ausleiher',
      'filter_libraries': 'Bibliotheken',
      // Loan Dialog
      'lend_book_title': 'Buch ausleihen',
      'no_borrowers_found': 'Keine Ausleiher gefunden. Fügen Sie zuerst einen Kontakt hinzu.',
      'select_contact_lend': 'Wählen Sie einen Kontakt, um dieses Buch auszuleihen:',
      'lend_btn': 'Ausleihen',
      // Scan Screen
      'scan_isbn_title': 'ISBN scannen',
      // External Search
      'external_search_title': 'Externe Buchsuche',
      'enter_search_term': 'Bitte geben Sie mindestens einen Suchbegriff ein',
      'failed_add_book': 'Fehler beim Hinzufügen des Buches',
      'search_open_library': 'Online suchen',
      // Search Peer
      'request_sent_to': 'Anfrage gesendet an',
      'connection_error': 'Verbindungsfehler',
      'scan_qr_code': 'Oder QR-Code scannen',
      'already_connected': 'Bereits verbunden',
      'add_peer_btn': 'Hinzufügen',
      'peer_search_hint': 'Bsp: Thomas\' Bibliothek',
      // Setup Screen
      'choose_profile_type': 'Profiltyp wählen',
      'profile_usage_question': 'Wie werden Sie BiblioGenius nutzen?',
      'customize_avatar': 'Avatar anpassen',
      'setup_failed': 'Einrichtung fehlgeschlagen',
      'lang_en': 'Englisch',
      'lang_fr': 'Französisch',
      'lang_es': 'Spanisch',
      'lang_de': 'Deutsch',
      'theme_default': 'Standard (Bunt)',
      'theme_minimal': 'Minimal (Sauber)',
      // Login Screen
      'login_title': 'Anmelden',
      'login_btn': 'Anmelden',
      'new_server_setup': 'Neuer Server? Einrichtung starten',
      // Contact Details
      'contact_details_title': 'Kontaktdetails',
      'edit_feature_soon': 'Bearbeitungsfunktion kommt bald',
      // Book List
      'menu_edit': 'Bearbeiten',
      'menu_manage_copies': 'Exemplare verwalten',
      // Book Status
      'status_available': 'Verfügbar',
      'status_checked_out': 'Ausgeliehen',
      'status_reference': 'Nur Präsenz',
      'status_missing': 'Fehlend/Verloren',
      'status_damaged': 'Beschädigt/Reparatur',
      'status_on_order': 'Bestellt',
    },
  };

  static String translate(BuildContext context, String key) {
    final themeProvider = Provider.of<ThemeProvider>(context, listen: false);
    final lang = themeProvider.locale.languageCode;
    // debugPrint('Translating $key for $lang');
    
    // 1. Check dynamic translations for current lang
    if (_dynamicTranslations.containsKey(lang) && _dynamicTranslations[lang]!.containsKey(key)) {
      return _dynamicTranslations[lang]![key]!;
    }

    // 2. Check static translations for current lang
    if (_localizedValues.containsKey(lang) && _localizedValues[lang]!.containsKey(key)) {
      return _localizedValues[lang]![key]!;
    }

    // 3. Fallback to English dynamic
    if (_dynamicTranslations.containsKey('en') && _dynamicTranslations['en']!.containsKey(key)) {
      return _dynamicTranslations['en']![key]!;
    }

    // 4. Fallback to English static
    return _localizedValues['en']?[key] ?? key;
  }
}
